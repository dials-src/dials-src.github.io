


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cctbx.maptbx &#8212; DIALS  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/dials-styles.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="logoheader container">
  <a href="../../index.html">
  <img class="logoheader" alt="DIALS" src="../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cctbx.maptbx</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">cctbx.sgtbx</span>

<span class="kn">import</span> <span class="nn">boost.python</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span>
<span class="n">ext</span> <span class="o">=</span> <span class="n">boost</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">import_ext</span><span class="p">(</span><span class="s2">&quot;cctbx_maptbx_ext&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">cctbx_maptbx_ext</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">crystal</span>
<span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">sgtbx</span>
<span class="kn">from</span> <span class="nn">cctbx.array_family</span> <span class="kn">import</span> <span class="n">flex</span>
<span class="kn">from</span> <span class="nn">scitbx</span> <span class="kn">import</span> <span class="n">matrix</span>
<span class="kn">from</span> <span class="nn">scitbx.python_utils</span> <span class="kn">import</span> <span class="n">dicts</span>
<span class="kn">from</span> <span class="nn">libtbx</span> <span class="kn">import</span> <span class="n">adopt_init_args</span>
<span class="kn">from</span> <span class="nn">libtbx.utils</span> <span class="kn">import</span> <span class="n">Sorry</span>
<span class="kn">import</span> <span class="nn">libtbx.load_env</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scitbx.math</span>
<span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">adptbx</span>
<span class="kn">from</span> <span class="nn">libtbx</span> <span class="kn">import</span> <span class="n">group_args</span>
<span class="kn">from</span> <span class="nn">scitbx</span> <span class="kn">import</span> <span class="n">fftpack</span>
<span class="kn">from</span> <span class="nn">libtbx.test_utils</span> <span class="kn">import</span> <span class="n">approx_equal</span>
<span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">uctbx</span>
<span class="kn">import</span> <span class="nn">scitbx.math</span>

<span class="n">debug_peak_cluster_analysis</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
  <span class="s2">&quot;CCTBX_MAPTBX_DEBUG_PEAK_CLUSTER_ANALYSIS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="nd">@boost</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">inject_into</span><span class="p">(</span><span class="n">connectivity</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_</span><span class="p">():</span>

  <span class="k">def</span> <span class="nf">get_blobs_boundaries_tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get lists of minimum and maximum coordinates for each connected</span>
<span class="sd">    region.</span>
<span class="sd">    returns 2 lists of tuples: first is minimum, second is maximum coordinates.</span>
<span class="sd">    [(x0,y0,z0), (x1,y1,z1), ...] where 0,1,... - number of region</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">boundaries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_blobs_boundaries</span><span class="p">()</span>
    <span class="n">regs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">()</span>
    <span class="n">min_boundaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_boundaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regs</span><span class="p">)):</span>
      <span class="n">minb</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">maxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundaries</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">boundaries</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">boundaries</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">min_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minb</span><span class="p">)</span>
      <span class="n">max_boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">min_boundaries</span><span class="p">,</span> <span class="n">max_boundaries</span>

<span class="k">def</span> <span class="nf">smooth_map</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">crystal_symmetry</span><span class="p">,</span> <span class="n">rad_smooth</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span>
     <span class="n">non_negative</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">miller</span>
  <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;box_average&quot;</span><span class="p">]</span>
  <span class="n">map_smooth</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;exp&quot;</span><span class="p">):</span>
    <span class="n">f_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">structure_factor_box_from_map</span><span class="p">(</span>
      <span class="nb">map</span>              <span class="o">=</span> <span class="nb">map</span><span class="p">,</span>
      <span class="n">crystal_symmetry</span> <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="p">,</span>
      <span class="n">include_000</span>      <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">ddd</span><span class="o">=</span><span class="n">f_map</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
    <span class="n">ddd</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">ddd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="mf">1.e+10</span><span class="p">)</span>  <span class="c1"># d_spacing for (0,0,0) was set to -1</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">ddd</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span>
    <span class="n">b_smooth</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">rad_smooth</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">smooth_scale</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b_smooth</span><span class="o">*</span><span class="n">ss</span><span class="p">)</span>
    <span class="n">f_map</span> <span class="o">=</span> <span class="n">f_map</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">f_map</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">*</span><span class="n">smooth_scale</span><span class="p">)</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="n">crystal_gridding</span><span class="p">(</span>
      <span class="n">unit_cell</span>             <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
      <span class="n">space_group_info</span>      <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">(),</span>
      <span class="n">pre_determined_n_real</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="n">fft_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span>
      <span class="n">crystal_gridding</span>     <span class="o">=</span> <span class="n">cg</span><span class="p">,</span>
      <span class="n">fourier_coefficients</span> <span class="o">=</span> <span class="n">f_map</span><span class="p">)</span>
    <span class="n">fft_map</span><span class="o">.</span><span class="n">apply_volume_scaling</span><span class="p">()</span>
    <span class="n">map_smooth</span> <span class="o">=</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">non_negative</span><span class="p">:</span>
      <span class="n">map_smooth</span> <span class="o">=</span> <span class="n">map_smooth</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">map_smooth</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;box_average&quot;</span><span class="p">):</span> <span class="c1"># assume 0/1 binary map</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1.e-6</span>
    <span class="n">mmin</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mmin</span><span class="o">&lt;</span><span class="mf">1.e-6</span> <span class="ow">and</span> <span class="n">mmin</span><span class="o">&gt;=</span><span class="mf">0.0</span>
    <span class="n">map_smooth</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
      <span class="n">maptbx</span><span class="o">.</span><span class="n">map_box_average</span><span class="p">(</span>
        <span class="n">map_data</span>      <span class="o">=</span> <span class="n">map_smooth</span><span class="p">,</span>
        <span class="n">index_span</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
      <span class="n">maptbx</span><span class="o">.</span><span class="n">map_box_average</span><span class="p">(</span>
        <span class="n">map_data</span>      <span class="o">=</span> <span class="n">map_smooth</span><span class="p">,</span>
        <span class="n">cutoff</span>        <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
        <span class="n">index_span</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">map_smooth</span>

<span class="k">class</span> <span class="nc">d99</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crystal_symmetry</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">adopt_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="k">assert</span> <span class="n">f_map</span> <span class="ow">is</span> <span class="kc">None</span>
      <span class="k">assert</span> <span class="n">crystal_symmetry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
      <span class="nb">map</span> <span class="o">=</span> <span class="n">shift_origin_if_needed</span><span class="p">(</span><span class="n">map_data</span><span class="o">=</span><span class="nb">map</span><span class="p">)</span><span class="o">.</span><span class="n">map_data</span>
      <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">miller</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">f_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">structure_factor_box_from_map</span><span class="p">(</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span><span class="p">,</span> <span class="n">crystal_symmetry</span> <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">assert</span> <span class="p">[</span><span class="nb">map</span><span class="p">,</span> <span class="n">crystal_symmetry</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">d_spacings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_map</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sort_permutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">d_spacings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_spacings</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">f_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_map</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">d_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">),</span> <span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">d99</span><span class="p">(</span>
      <span class="n">f</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_map</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span>
      <span class="n">d_spacings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">,</span>
      <span class="n">hkl</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_map</span><span class="o">.</span><span class="n">indices</span><span class="p">(),</span>
      <span class="n">d_min</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span><span class="p">,</span>
      <span class="n">d_max</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_max</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">group_args</span><span class="p">(</span>
      <span class="n">d9</span>      <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">d_min_cc9</span><span class="p">(),</span>
      <span class="n">d99</span>     <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">d_min_cc99</span><span class="p">(),</span>
      <span class="n">d999</span>    <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">d_min_cc999</span><span class="p">(),</span>
      <span class="n">d9999</span>   <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">d_min_cc9999</span><span class="p">(),</span>
      <span class="n">d99999</span>  <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">d_min_cc99999</span><span class="p">(),</span>
      <span class="n">d999999</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">d_min_cc999999</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%12.6f</span><span class="s2"> </span><span class="si">%8.6f</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">d_min</span><span class="p">,</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">d_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">ccs</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">%</span><span class="p">(</span><span class="n">d_min</span><span class="p">,</span> <span class="n">cc</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">assert_same_gridding</span><span class="p">(</span><span class="n">map_1</span><span class="p">,</span> <span class="n">map_2</span><span class="p">,</span>
                         <span class="n">Sorry_message</span><span class="o">=</span><span class="s2">&quot;Maps have different gridding.&quot;</span><span class="p">):</span>
  <span class="n">f1</span> <span class="o">=</span> <span class="n">map_1</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span><span class="o">==</span><span class="n">map_2</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span>
  <span class="n">f2</span> <span class="o">=</span> <span class="n">map_1</span><span class="o">.</span><span class="n">origin</span><span class="p">()</span><span class="o">==</span><span class="n">map_2</span><span class="o">.</span><span class="n">origin</span><span class="p">()</span>
  <span class="n">f3</span> <span class="o">=</span> <span class="n">map_1</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">==</span><span class="n">map_2</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
  <span class="k">if</span><span class="p">([</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">,</span><span class="n">f3</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">!=</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">Sorry</span><span class="p">(</span><span class="n">Sorry_message</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">shift_origin_if_needed</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">sites_cart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crystal_symmetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ncs_object</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">shift_needed</span> <span class="o">=</span> <span class="ow">not</span> \
    <span class="p">(</span><span class="n">map_data</span><span class="o">.</span><span class="n">focus_size_1d</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">map_data</span><span class="o">.</span><span class="n">nd</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span>
     <span class="n">map_data</span><span class="o">.</span><span class="n">is_0_based</span><span class="p">())</span>
  <span class="n">shift_frac</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">shift_cart</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">if</span><span class="p">(</span><span class="n">shift_needed</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">origin</span><span class="p">()</span>
    <span class="n">original_origin_grid_units</span><span class="o">=</span><span class="n">O</span>
    <span class="n">map_data</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">shift_origin</span><span class="p">()</span>
    <span class="n">original_origin_cart</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">crystal_symmetry</span><span class="p">:</span>
      <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">space_group</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="p">()</span><span class="o">.</span><span class="n">number</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">Sorry</span><span class="p">(</span><span class="s2">&quot;Space groups other than P1 are not supported.&quot;</span><span class="p">)</span>
      <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">()</span><span class="o">.</span><span class="n">parameters</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
      <span class="n">fm</span> <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">()</span><span class="o">.</span><span class="n">fractionalization_matrix</span><span class="p">()</span>
      <span class="n">sx</span><span class="p">,</span><span class="n">sy</span><span class="p">,</span><span class="n">sz</span> <span class="o">=</span> <span class="n">O</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">O</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">O</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="n">shift_frac</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sx</span><span class="p">,</span><span class="o">-</span><span class="n">sy</span><span class="p">,</span><span class="o">-</span><span class="n">sz</span><span class="p">]</span>
      <span class="n">shift_cart</span> <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">()</span><span class="o">.</span><span class="n">orthogonalize</span><span class="p">(</span><span class="n">shift_frac</span><span class="p">)</span>
      <span class="n">original_origin_cart</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="o">-</span><span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">shift_cart</span><span class="p">))</span>
      <span class="k">if</span><span class="p">(</span><span class="n">sites_cart</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">sites_cart</span> <span class="o">=</span> <span class="n">sites_cart</span> <span class="o">+</span> <span class="n">flex</span><span class="o">.</span><span class="n">vec3_double</span><span class="p">(</span><span class="n">sites_cart</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">shift_cart</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">ncs_object</span><span class="p">:</span>
        <span class="n">ncs_object</span><span class="o">=</span><span class="n">ncs_object</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">(</span><span class="n">coordinate_offset</span><span class="o">=</span><span class="n">shift_cart</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">original_origin_grid_units</span><span class="o">=</span><span class="kc">None</span>
      <span class="n">original_origin_cart</span><span class="o">=</span><span class="kc">None</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">original_origin_grid_units</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">original_origin_cart</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">group_args</span><span class="p">(</span>
    <span class="n">map_data</span>   <span class="o">=</span> <span class="n">map_data</span><span class="p">,</span>
    <span class="n">ncs_object</span> <span class="o">=</span> <span class="n">ncs_object</span><span class="p">,</span>
    <span class="n">sites_cart</span> <span class="o">=</span> <span class="n">sites_cart</span><span class="p">,</span>
    <span class="n">shift_frac</span> <span class="o">=</span> <span class="n">shift_frac</span><span class="p">,</span>
    <span class="n">shift_cart</span> <span class="o">=</span> <span class="n">shift_cart</span><span class="p">,</span>
    <span class="n">original_origin_grid_units</span> <span class="o">=</span> <span class="n">original_origin_grid_units</span><span class="p">,</span>
    <span class="n">original_origin_cart</span> <span class="o">=</span> <span class="n">original_origin_cart</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">value_at_closest_grid_point</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">x_frac</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">map</span><span class="p">[</span><span class="n">closest_grid_point</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">accessor</span><span class="p">(),</span> <span class="n">x_frac</span><span class="p">)]</span>

<span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="o">.</span><span class="n">value_at_closest_grid_point</span> <span class="o">=</span> <span class="n">value_at_closest_grid_point</span>
<span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="o">.</span><span class="n">value_at_closest_grid_point</span> <span class="o">=</span> <span class="n">value_at_closest_grid_point</span>
<span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="o">.</span><span class="n">eight_point_interpolation</span> <span class="o">=</span> <span class="n">eight_point_interpolation</span>
<span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="o">.</span><span class="n">eight_point_interpolation_with_gradients</span> <span class="o">=</span> \
  <span class="n">eight_point_interpolation_with_gradients</span>
<span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="o">.</span><span class="n">quadratic_interpolation_with_gradients</span> <span class="o">=</span> \
  <span class="n">quadratic_interpolation_with_gradients</span>
<span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="o">.</span><span class="n">tricubic_interpolation</span> <span class="o">=</span> <span class="n">tricubic_interpolation</span>
<span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="o">.</span><span class="n">tricubic_interpolation_with_gradients</span> <span class="o">=</span> <span class="n">tricubic_interpolation_with_gradients</span>

<span class="k">def</span> <span class="nf">cc_peak</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">map_1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">map_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_coeffs_1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">map_coeffs_2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Compute CCpeak as described in</span>
<span class="sd">    Acta Cryst. (2014). D70, 2593-2606</span>
<span class="sd">    Metrics for comparison of crystallographic maps</span>
<span class="sd">    A. Urzhumtsev, P. V. Afonine, V. Y. Lunin, T. C. Terwilliger and P. D. Adams</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">miller</span>
  <span class="k">assert</span> <span class="p">[</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
  <span class="k">assert</span> <span class="p">[</span><span class="n">map_coeffs_1</span><span class="p">,</span><span class="n">map_coeffs_2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
  <span class="k">if</span><span class="p">([</span><span class="n">map_1</span><span class="p">,</span><span class="n">map_2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
    <span class="c1"># Maps are assumed to be quantile rank scaled (HE).</span>
    <span class="k">return</span> <span class="n">ext</span><span class="o">.</span><span class="n">cc_peak</span><span class="p">(</span><span class="n">map_1</span><span class="o">=</span><span class="n">map_1</span><span class="p">,</span> <span class="n">map_2</span><span class="o">=</span><span class="n">map_2</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">([</span><span class="n">map_coeffs_1</span><span class="p">,</span><span class="n">map_coeffs_2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">d_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">map_coeffs_1</span><span class="o">.</span><span class="n">d_min</span><span class="p">(),</span> <span class="n">map_coeffs_2</span><span class="o">.</span><span class="n">d_min</span><span class="p">())</span>
    <span class="n">crystal_gridding</span> <span class="o">=</span> <span class="n">map_coeffs_1</span><span class="o">.</span><span class="n">crystal_gridding</span><span class="p">(</span>
      <span class="n">d_min</span>             <span class="o">=</span> <span class="n">d_min</span><span class="p">,</span>
      <span class="n">symmetry_flags</span>    <span class="o">=</span> <span class="n">use_space_group_symmetry</span><span class="p">,</span>
      <span class="n">resolution_factor</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">)</span>
    <span class="n">fft_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span>
      <span class="n">crystal_gridding</span>     <span class="o">=</span> <span class="n">crystal_gridding</span><span class="p">,</span>
      <span class="n">fourier_coefficients</span> <span class="o">=</span> <span class="n">map_coeffs_1</span><span class="p">)</span>
    <span class="n">map_1</span> <span class="o">=</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
    <span class="n">fft_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span>
      <span class="n">crystal_gridding</span>     <span class="o">=</span> <span class="n">crystal_gridding</span><span class="p">,</span>
      <span class="n">fourier_coefficients</span> <span class="o">=</span> <span class="n">map_coeffs_2</span><span class="p">)</span>
    <span class="n">map_2</span> <span class="o">=</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
    <span class="n">m1_he</span> <span class="o">=</span> <span class="n">volume_scale</span><span class="p">(</span><span class="nb">map</span> <span class="o">=</span> <span class="n">map_1</span><span class="p">,</span>  <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span><span class="o">.</span><span class="n">map_data</span><span class="p">()</span>
    <span class="n">m2_he</span> <span class="o">=</span> <span class="n">volume_scale</span><span class="p">(</span><span class="nb">map</span> <span class="o">=</span> <span class="n">map_2</span><span class="p">,</span>  <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span><span class="o">.</span><span class="n">map_data</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ext</span><span class="o">.</span><span class="n">cc_peak</span><span class="p">(</span><span class="n">map_1</span><span class="o">=</span><span class="n">m1_he</span><span class="p">,</span> <span class="n">map_2</span><span class="o">=</span><span class="n">m2_he</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">Sorry</span><span class="p">(</span><span class="s2">&quot;Combination of inputs not supported.&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">map_accumulator</span><span class="p">(</span><span class="n">n_real</span><span class="p">,</span> <span class="n">use_max_map</span><span class="p">,</span> <span class="n">smearing_b</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_peak_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">smearing_span</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">use_exp_table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Good defaults for 2mFo-DFc type maps:</span>
<span class="sd">    smearing_b=1, max_peak_scale=100, smearing_span=5</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">ext</span><span class="o">.</span><span class="n">map_accumulator</span><span class="p">(</span><span class="n">n_real</span><span class="o">=</span><span class="n">n_real</span><span class="p">,</span> <span class="n">smearing_b</span><span class="o">=</span><span class="n">smearing_b</span><span class="p">,</span>
    <span class="n">max_peak_scale</span><span class="o">=</span><span class="n">max_peak_scale</span><span class="p">,</span> <span class="n">smearing_span</span><span class="o">=</span><span class="n">smearing_span</span><span class="p">,</span>
      <span class="n">use_exp_table</span><span class="o">=</span><span class="n">use_exp_table</span><span class="p">,</span> <span class="n">use_max_map</span><span class="o">=</span><span class="n">use_max_map</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">peak_volume_estimate</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">sites_cart</span><span class="p">,</span> <span class="n">crystal_symmetry</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span>
      <span class="n">atom_radius</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
  <span class="n">v</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
  <span class="n">sites_frac</span> <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">()</span><span class="o">.</span><span class="n">fractionalize</span><span class="p">(</span><span class="n">sites_cart</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">sc</span><span class="p">,</span> <span class="n">sf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sites_cart</span><span class="p">,</span> <span class="n">sites_frac</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">map_data</span><span class="o">.</span><span class="n">value_at_closest_grid_point</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">cutoff</span><span class="p">):</span>
      <span class="n">sel</span> <span class="o">=</span> <span class="n">grid_indices_around_sites</span><span class="p">(</span>
        <span class="n">unit_cell</span>  <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
        <span class="n">fft_n_real</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">focus</span><span class="p">(),</span>
        <span class="n">fft_m_real</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="n">sites_cart</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">vec3_double</span><span class="p">([</span><span class="n">sc</span><span class="p">]),</span>
        <span class="n">site_radii</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="n">atom_radius</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">map_data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">cutoff</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">min_default</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
  <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">by_sigma_less_than</span><span class="p">,</span> <span class="n">scale_by</span><span class="p">,</span> <span class="n">set_value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Trunate map inplace by standard deviation (sigma) while scale it with</span>
<span class="sd">  specified scale, such as volume (scale_by=1/volume) or sigma</span>
<span class="sd">  (scale_by=1/standard_deviation). Input map_data is expected to be unscaled (</span>
<span class="sd">  right out of FT).</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">sigma</span> <span class="o">=</span> <span class="n">statistics</span><span class="p">(</span><span class="n">map_data</span><span class="p">)</span><span class="o">.</span><span class="n">sigma</span><span class="p">()</span>
  <span class="k">if</span><span class="p">(</span><span class="n">sigma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">map_data</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">*</span><span class="n">scale_by</span>
    <span class="k">return</span>
  <span class="n">ext</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span>
    <span class="n">map_data</span>           <span class="o">=</span> <span class="n">map_data</span><span class="p">,</span>
    <span class="n">standard_deviation</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span>
    <span class="n">by_sigma_less_than</span> <span class="o">=</span> <span class="n">by_sigma_less_than</span><span class="p">,</span>
    <span class="n">scale_by</span>           <span class="o">=</span> <span class="n">scale_by</span><span class="p">,</span>
    <span class="n">set_value</span>          <span class="o">=</span> <span class="n">set_value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">xray_structure</span><span class="p">,</span>
         <span class="n">n_real</span><span class="p">,</span>
         <span class="n">mask_value_inside_molecule</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
         <span class="n">mask_value_outside_molecule</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
         <span class="n">solvent_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
         <span class="n">atom_radius</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">xrs_p1</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="o">.</span><span class="n">expand_to_p1</span><span class="p">(</span><span class="n">sites_mod_positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">atom_radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">cctbx.masks</span> <span class="kn">import</span> <span class="n">vdw_radii_from_xray_structure</span>
    <span class="n">atom_radii</span> <span class="o">=</span> <span class="n">vdw_radii_from_xray_structure</span><span class="p">(</span><span class="n">xray_structure</span> <span class="o">=</span> <span class="n">xrs_p1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">atom_radii</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">xrs_p1</span><span class="o">.</span><span class="n">scatterers</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">atom_radius</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ext</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
    <span class="n">sites_frac</span>                  <span class="o">=</span> <span class="n">xrs_p1</span><span class="o">.</span><span class="n">sites_frac</span><span class="p">(),</span>
    <span class="n">unit_cell</span>                   <span class="o">=</span> <span class="n">xrs_p1</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
    <span class="n">n_real</span>                      <span class="o">=</span> <span class="n">n_real</span><span class="p">,</span>
    <span class="n">mask_value_inside_molecule</span>  <span class="o">=</span> <span class="n">mask_value_inside_molecule</span><span class="p">,</span>
    <span class="n">mask_value_outside_molecule</span> <span class="o">=</span> <span class="n">mask_value_outside_molecule</span><span class="p">,</span>
    <span class="n">radii</span>                       <span class="o">=</span> <span class="n">atom_radii</span> <span class="o">+</span> <span class="n">solvent_radius</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">statistics</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">statistics</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">):</span>
    <span class="n">ext</span><span class="o">.</span><span class="n">statistics</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">)</span>

<span class="nd">@boost</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">inject_into</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">statistics</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_</span><span class="p">():</span>

  <span class="k">def</span> <span class="nf">show_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="n">f</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;max </span><span class="si">%.6g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;min </span><span class="si">%.6g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;mean </span><span class="si">%.6g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;sigma </span><span class="si">%.6g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">()),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

<span class="n">use_space_group_symmetry</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">search_symmetry_flags</span><span class="p">(</span>
  <span class="n">use_space_group_symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nd">@boost</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">inject_into</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">histogram</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_</span><span class="p">():</span>

  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Injector for extending cctbx.maptbx.histogram</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># XXX make a method of scitbx</span>
  <span class="k">def</span> <span class="nf">get_percentile_cutoffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">vol_cutoff_plus_percent</span><span class="p">,</span>
      <span class="n">vol_cutoff_minus_percent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For the double-step filtration in cctbx.miller (used as part of the</span>
<span class="sd">    procedure for replacing missing F-obs in maps), we need to calculate upper</span>
<span class="sd">    and lower cutoffs for the data based on percentile values.  This can be</span>
<span class="sd">    done in just a few lines of code by using flex.sort_permutation over the</span>
<span class="sd">    entire map, but this has a huge memory overhead (and possibly computational</span>
<span class="sd">    overhead as well).  Since we are only interested in subsets of values at</span>
<span class="sd">    the extreme ends of the distribution, we can perform the sort for these</span>
<span class="sd">    subsets instead, which should cut down on memory use.</span>

<span class="sd">    Returns the upper and lower map value cutoffs (as Python floats).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">map_values</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">map_values</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="c1"># upper limit</span>
    <span class="n">i_bin_plus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i_bin</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_values</span><span class="p">()):</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">value</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">vol_cutoff_plus_percent</span><span class="p">):</span>
        <span class="n">i_bin_plus</span> <span class="o">=</span> <span class="n">i_bin</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">break</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">i_bin_plus</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cutoffp_lower_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">()[</span><span class="n">i_bin_plus</span><span class="p">]</span>
    <span class="n">top_values</span> <span class="o">=</span> <span class="n">map_values</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">map_values</span> <span class="o">&gt;=</span> <span class="n">cutoffp_lower_limit</span><span class="p">)</span>
    <span class="n">i_upper</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="n">vol_cutoff_plus_percent</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">)),</span>
                  <span class="n">top_values</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sort_permutation</span><span class="p">(</span><span class="n">top_values</span><span class="p">)</span>
    <span class="n">top_values_sorted</span> <span class="o">=</span> <span class="n">top_values</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">s</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">top_values_sorted</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">i_upper</span><span class="p">)</span>
    <span class="n">cutoffp</span> <span class="o">=</span> <span class="n">top_values_sorted</span><span class="p">[</span><span class="o">-</span><span class="n">i_upper</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">top_values</span>
    <span class="k">del</span> <span class="n">top_values_sorted</span>
    <span class="c1"># lower limit</span>
    <span class="n">i_bin_minus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i_bin</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_values</span><span class="p">()):</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">value</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vol_cutoff_minus_percent</span><span class="p">):</span>
        <span class="n">i_bin_minus</span> <span class="o">=</span> <span class="n">i_bin</span>
        <span class="k">break</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">i_bin_minus</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cutoffm_upper_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">()[</span><span class="n">i_bin_minus</span><span class="p">]</span>
    <span class="n">bottom_values</span> <span class="o">=</span> <span class="n">map_values</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">map_values</span> <span class="o">&lt;=</span> <span class="n">cutoffm_upper_limit</span><span class="p">)</span>
    <span class="n">i_lower</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="n">vol_cutoff_minus_percent</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">)),</span>
                  <span class="n">bottom_values</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sort_permutation</span><span class="p">(</span><span class="n">bottom_values</span><span class="p">)</span>
    <span class="n">bottom_values_sorted</span> <span class="o">=</span> <span class="n">bottom_values</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">s</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">bottom_values_sorted</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">i_lower</span><span class="p">)</span>
    <span class="n">cutoffm</span> <span class="o">=</span> <span class="n">bottom_values_sorted</span><span class="p">[</span><span class="n">i_lower</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">bottom_values</span>
    <span class="k">del</span> <span class="n">bottom_values_sorted</span>
    <span class="k">return</span> <span class="n">cutoffp</span><span class="p">,</span> <span class="n">cutoffm</span>

<span class="k">class</span> <span class="nc">peak_list</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">peak_list</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                     <span class="n">tags</span><span class="p">,</span>
                     <span class="n">peak_search_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">max_peaks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">peak_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">peak_cutoff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">ext</span><span class="o">.</span><span class="n">peak_list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">peak_search_level</span><span class="p">,</span> <span class="n">max_peaks</span><span class="p">,</span> <span class="n">interpolate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ext</span><span class="o">.</span><span class="n">peak_list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">peak_search_level</span><span class="p">,</span> <span class="n">peak_cutoff</span><span class="p">,</span> <span class="n">max_peaks</span><span class="p">,</span> <span class="n">interpolate</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">as_CObjectZYX</span><span class="p">(</span><span class="n">map_unit_cell</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">apply_sigma_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">ext</span><span class="o">.</span><span class="n">as_CObjectZYX</span><span class="p">(</span><span class="n">map_unit_cell</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">apply_sigma_scaling</span><span class="p">)</span>

<span class="n">structure_factors</span> <span class="o">=</span> <span class="n">dicts</span><span class="o">.</span><span class="n">easy</span><span class="p">(</span>
  <span class="n">to_map</span><span class="o">=</span><span class="n">structure_factors_to_map</span><span class="p">,</span>
  <span class="n">from_map</span><span class="o">=</span><span class="n">structure_factors_from_map</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">crystal_gridding</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_cell</span><span class="p">,</span>
                     <span class="n">d_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">resolution_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">symmetry_flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">space_group_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">mandatory_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">max_prime</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">assert_shannon_sampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">pre_determined_n_real</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pre_determined_n_real</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="k">assert</span> <span class="p">[</span><span class="n">d_min</span><span class="p">,</span> <span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">d_min</span> <span class="o">=</span> <span class="n">step</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">resolution_factor</span> <span class="o">=</span> <span class="mf">0.5</span>
      <span class="k">elif</span> <span class="p">(</span><span class="n">resolution_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">resolution_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">symmetry_flags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> <span class="k">assert</span> <span class="n">space_group_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mandatory_factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="n">mandatory_factors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mandatory_factors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">assert</span> <span class="n">d_min</span> <span class="ow">is</span> <span class="kc">None</span>
      <span class="k">assert</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span>
      <span class="k">assert</span> <span class="n">mandatory_factors</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">adopt_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">(),</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pre_determined_n_real</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_n_real</span> <span class="o">=</span> <span class="n">pre_determined_n_real</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">symmetry_flags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_n_real</span> <span class="o">=</span> <span class="n">determine_gridding</span><span class="p">(</span>
        <span class="n">unit_cell</span><span class="p">,</span> <span class="n">d_min</span><span class="p">,</span> <span class="n">resolution_factor</span><span class="p">,</span>
        <span class="n">symmetry_flags</span><span class="p">,</span> <span class="n">space_group_info</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>
        <span class="n">mandatory_factors</span><span class="p">,</span> <span class="n">max_prime</span><span class="p">,</span> <span class="n">assert_shannon_sampling</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_n_real</span> <span class="o">=</span> <span class="n">determine_gridding</span><span class="p">(</span>
        <span class="n">unit_cell</span><span class="p">,</span> <span class="n">d_min</span><span class="p">,</span> <span class="n">resolution_factor</span><span class="p">,</span>
        <span class="n">mandatory_factors</span><span class="p">,</span> <span class="n">max_prime</span><span class="p">,</span> <span class="n">assert_shannon_sampling</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_copy_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unit_cell</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_unit_cell</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_d_min</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_d_min</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resolution_factor</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_resolution_factor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_symmetry_flags</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_symmetry_flags</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_space_group_info</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_space_group_info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_mandatory_factors</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_mandatory_factors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_max_prime</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_max_prime</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_n_real</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_n_real</span>

  <span class="k">def</span> <span class="nf">unit_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_cell</span>

  <span class="k">def</span> <span class="nf">d_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_min</span>

  <span class="k">def</span> <span class="nf">resolution_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolution_factor</span>

  <span class="k">def</span> <span class="nf">symmetry_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetry_flags</span>

  <span class="k">def</span> <span class="nf">space_group_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space_group_info</span>

  <span class="k">def</span> <span class="nf">change_space_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space_group_info</span><span class="p">):</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">space_group_info</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">refine_gridding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_real</span><span class="p">())</span>
            <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_real</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_space_group_info</span> <span class="o">=</span> <span class="n">space_group_info</span>

  <span class="k">def</span> <span class="nf">mandatory_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mandatory_factors</span>

  <span class="k">def</span> <span class="nf">max_prime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_prime</span>

  <span class="k">def</span> <span class="nf">n_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_real</span>

  <span class="k">def</span> <span class="nf">space_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">()</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">crystal_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">crystal</span><span class="o">.</span><span class="n">symmetry</span><span class="p">(</span>
      <span class="n">unit_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
      <span class="n">space_group_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">n_grid_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_real</span><span class="p">():</span>
      <span class="n">result</span> <span class="o">*=</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">crystal_gridding_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">crystal_gridding_tags</span><span class="p">(</span><span class="n">crystal_gridding</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridding</span><span class="p">):</span>
    <span class="n">crystal_gridding</span><span class="o">.</span><span class="n">_copy_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridding</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gridding</span><span class="o">.</span><span class="n">symmetry_flags</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">grid_tags</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_real</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
      <span class="n">space_group_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>
      <span class="n">symmetry_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry_flags</span><span class="p">())</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="o">.</span><span class="n">n_grid_misses</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>

  <span class="k">def</span> <span class="nf">peak_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">verify_symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="n">peak_search_parameters</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verify_symmetry</span> <span class="ow">and</span> <span class="n">libtbx</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">full_testing</span><span class="p">):</span>
      <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">accessor</span><span class="p">()</span><span class="o">.</span><span class="n">is_padded</span><span class="p">()):</span>
      <span class="nb">map</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">flex</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">focus</span><span class="p">()))</span>
    <span class="n">grid_peaks</span> <span class="o">=</span> <span class="n">peak_list</span><span class="p">(</span>
      <span class="n">data</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span>
      <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="o">.</span><span class="n">tag_array</span><span class="p">(),</span>
      <span class="n">peak_search_level</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">peak_search_level</span><span class="p">(),</span>
      <span class="n">max_peaks</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">max_peaks</span><span class="p">(),</span>
      <span class="n">peak_cutoff</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">peak_cutoff</span><span class="p">(),</span>
      <span class="n">interpolate</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">interpolate</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">min_distance_sym_equiv</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">grid_peaks</span>
    <span class="k">return</span> <span class="n">peak_cluster_analysis</span><span class="p">(</span>
      <span class="n">peak_list</span><span class="o">=</span><span class="n">grid_peaks</span><span class="p">,</span>
      <span class="n">special_position_settings</span><span class="o">=</span><span class="n">crystal</span><span class="o">.</span><span class="n">special_position_settings</span><span class="p">(</span>
        <span class="n">crystal_symmetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">(),</span>
        <span class="n">min_distance_sym_equiv</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">min_distance_sym_equiv</span><span class="p">()),</span>
      <span class="n">general_positions_only</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">general_positions_only</span><span class="p">(),</span>
      <span class="n">effective_resolution</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">effective_resolution</span><span class="p">(),</span>
      <span class="n">significant_height_fraction</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">significant_height_fraction</span><span class="p">(),</span>
      <span class="n">cluster_height_fraction</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">cluster_height_fraction</span><span class="p">(),</span>
      <span class="n">min_cross_distance</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">min_cross_distance</span><span class="p">(),</span>
      <span class="n">max_clusters</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">max_clusters</span><span class="p">(),</span>
      <span class="n">min_cubicle_edge</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">min_cubicle_edge</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">boxes_by_dimension</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">n_real</span><span class="p">,</span>
               <span class="n">abc</span><span class="p">,</span>
               <span class="n">dim</span><span class="p">,</span>
               <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_real</span> <span class="o">=</span> <span class="n">n_real</span>
    <span class="c1">#</span>
    <span class="n">step_1</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n_real</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># step size along edge</span>
    <span class="n">step_2</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n_real</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># step size along edge</span>
    <span class="n">step_3</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">n_real</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># step size along edge</span>
    <span class="n">i_step_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="o">/</span><span class="n">step_1</span><span class="p">)</span> <span class="c1"># points per box edge</span>
    <span class="n">i_step_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="o">/</span><span class="n">step_2</span><span class="p">)</span> <span class="c1"># points per box edge</span>
    <span class="n">i_step_3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="o">/</span><span class="n">step_3</span><span class="p">)</span> <span class="c1"># points per box edge</span>
    <span class="c1">#</span>
    <span class="n">n_boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_boxes</span><span class="p">(</span><span class="n">i_step_1</span><span class="p">,</span><span class="n">i_step_2</span><span class="p">,</span><span class="n">i_step_3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">n_boxes</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_generate_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ba</span><span class="p">,</span><span class="n">bb</span><span class="p">,</span><span class="n">bc</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">regroup</span><span class="p">(</span><span class="n">be</span><span class="p">):</span>
      <span class="n">maxe</span> <span class="o">=</span> <span class="n">be</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">be</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxe</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
      <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">be</span><span class="p">)):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
          <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">step</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">be</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">l</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">step</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">maxe</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">l</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">step</span>
          <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">result</span>
    <span class="n">be</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">ba</span><span class="p">,</span><span class="n">bb</span><span class="p">,</span><span class="n">bc</span><span class="p">]):</span>
      <span class="n">be_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box_edges</span><span class="p">(</span><span class="n">n_real_1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_real</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
      <span class="n">be_</span> <span class="o">=</span> <span class="n">regroup</span><span class="p">(</span><span class="n">be_</span><span class="p">)</span>
      <span class="n">be</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">be_</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">starts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ends</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">be</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">be</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">be</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_box_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_real_1d</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_real_1d</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span> <span class="n">limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_real_1d</span><span class="p">)</span>
    <span class="n">box_1d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">)):</span>
      <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>               <span class="n">box_1d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
      <span class="k">elif</span><span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="n">box_1d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">box_1d</span>

<span class="k">class</span> <span class="nc">boxes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Split box defined by n_real into boxes where each box is a fraction of the</span>
<span class="sd">  whole box.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">n_real</span><span class="p">,</span>
               <span class="n">fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">max_boxes</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
               <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_real</span> <span class="o">=</span> <span class="n">n_real</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">n_boxes</span> <span class="o">=</span> <span class="mf">1.e+9</span>
    <span class="n">n_boxes_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">n_boxes</span><span class="o">&gt;</span><span class="n">max_boxes</span><span class="p">:</span>
      <span class="n">ba</span><span class="p">,</span><span class="n">bb</span><span class="p">,</span><span class="n">bc</span> <span class="o">=</span> \
        <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">n_real</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">fraction</span><span class="p">))),</span> \
        <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">n_real</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">fraction</span><span class="p">))),</span> \
        <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">n_real</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">fraction</span><span class="p">)))</span>
      <span class="n">n_boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_boxes</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span><span class="n">bb</span><span class="p">,</span><span class="n">bc</span><span class="p">)</span>
      <span class="k">if</span><span class="p">(</span><span class="n">n_boxes_</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">n_boxes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">):</span> <span class="k">break</span>
      <span class="n">n_boxes_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_boxes</span><span class="p">)</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">n_boxes</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">log</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;n1,n2,n3 (n_real)  :&quot;</span><span class="p">,</span> <span class="n">n_real</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;points per box edge:&quot;</span><span class="p">,</span> <span class="n">ba</span><span class="p">,</span><span class="n">bb</span><span class="p">,</span><span class="n">bc</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;number of boxes    :&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_generate_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ba</span><span class="p">,</span><span class="n">bb</span><span class="p">,</span><span class="n">bc</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">regroup</span><span class="p">(</span><span class="n">be</span><span class="p">):</span>
      <span class="n">maxe</span> <span class="o">=</span> <span class="n">be</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">be</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxe</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
      <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">be</span><span class="p">)):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
          <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">step</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">be</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">l</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">step</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">maxe</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">l</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">step</span>
          <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">result</span>
    <span class="n">be</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">ba</span><span class="p">,</span><span class="n">bb</span><span class="p">,</span><span class="n">bc</span><span class="p">]):</span>
      <span class="n">be_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box_edges</span><span class="p">(</span><span class="n">n_real_1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_real</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
      <span class="n">be_</span> <span class="o">=</span> <span class="n">regroup</span><span class="p">(</span><span class="n">be_</span><span class="p">)</span>
      <span class="n">be</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">be_</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">starts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ends</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">be</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">be</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">be</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_box_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_real_1d</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_real_1d</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span> <span class="n">limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_real_1d</span><span class="p">)</span>
    <span class="n">box_1d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">)):</span>
      <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>               <span class="n">box_1d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
      <span class="k">elif</span><span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="n">box_1d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">box_1d</span>

<span class="k">class</span> <span class="nc">peak_search_parameters</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_search_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">max_peaks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">peak_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">min_distance_sym_equiv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">general_positions_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">effective_resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">significant_height_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">cluster_height_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">min_cross_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">max_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">min_cubicle_edge</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">adopt_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">(),</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_copy_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_peak_search_level</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_peak_search_level</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_max_peaks</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_max_peaks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_peak_cutoff</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_peak_cutoff</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_interpolate</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_interpolate</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_min_distance_sym_equiv</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_min_distance_sym_equiv</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_general_positions_only</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_general_positions_only</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_effective_resolution</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_effective_resolution</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_significant_height_fraction</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_significant_height_fraction</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_height_fraction</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_cluster_height_fraction</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_min_cross_distance</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_min_cross_distance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_max_clusters</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_max_clusters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_min_cubicle_edge</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_min_cubicle_edge</span>

  <span class="k">def</span> <span class="nf">peak_search_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_search_level</span>

  <span class="k">def</span> <span class="nf">max_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_peaks</span>

  <span class="k">def</span> <span class="nf">peak_cutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_cutoff</span>

  <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpolate</span>

  <span class="k">def</span> <span class="nf">min_distance_sym_equiv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_distance_sym_equiv</span>

  <span class="k">def</span> <span class="nf">general_positions_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_positions_only</span>

  <span class="k">def</span> <span class="nf">effective_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effective_resolution</span>

  <span class="k">def</span> <span class="nf">significant_height_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_significant_height_fraction</span>

  <span class="k">def</span> <span class="nf">cluster_height_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_height_fraction</span>

  <span class="k">def</span> <span class="nf">min_cross_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_cross_distance</span>

  <span class="k">def</span> <span class="nf">max_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_clusters</span>

  <span class="k">def</span> <span class="nf">min_cubicle_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_cubicle_edge</span>

<span class="k">class</span> <span class="nc">cluster_site_info</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_list_index</span><span class="p">,</span> <span class="n">grid_index</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak_list_index</span> <span class="o">=</span> <span class="n">peak_list_index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">grid_index</span> <span class="o">=</span> <span class="n">grid_index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">grid_height</span> <span class="o">=</span> <span class="n">grid_height</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>

<span class="k">class</span> <span class="nc">peak_cluster_analysis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_list</span><span class="p">,</span>
                     <span class="n">special_position_settings</span><span class="p">,</span>
                     <span class="n">general_positions_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">effective_resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">significant_height_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">cluster_height_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">min_cross_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">max_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">min_cubicle_edge</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">effective_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">significant_height_fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
          <span class="n">significant_height_fraction</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cluster_height_fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
          <span class="n">cluster_height_fraction</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">min_cross_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">min_cross_distance</span> <span class="o">=</span> <span class="n">special_position_settings</span><span class="o">.</span><span class="n">min_distance_sym_equiv</span><span class="p">()</span>
    <span class="n">adopt_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">(),</span> <span class="n">hide</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_cross_distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_gridding</span> <span class="o">=</span> <span class="n">peak_list</span><span class="o">.</span><span class="n">gridding</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">effective_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_is_processed</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="n">peak_list</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_is_processed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span>   <span class="n">effective_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="n">debug_peak_cluster_analysis</span> <span class="o">==</span> <span class="s2">&quot;use_old&quot;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_site_cluster_analysis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_site_cluster_analysis</span> <span class="o">=</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">_special_position_settings</span><span class="o">.</span><span class="n">site_cluster_analysis</span><span class="p">(</span>
          <span class="n">min_cross_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_cross_distance</span><span class="p">,</span>
          <span class="n">min_self_distance</span>
            <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_special_position_settings</span><span class="o">.</span><span class="n">min_distance_sym_equiv</span><span class="p">(),</span>
          <span class="n">general_positions_only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_general_positions_only</span><span class="p">,</span>
          <span class="n">min_cubicle_edge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_cubicle_edge</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_indices</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">size_t</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">vec3_double</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_heights</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_site_indices</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">size_t</span><span class="p">()</span>

  <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_with_effective_resolution</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_site_cluster_analysis</span><span class="p">()</span>

  <span class="nb">next</span> <span class="o">=</span> <span class="fm">__next__</span>

  <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">max_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_with_effective_resolution</span><span class="p">(</span><span class="n">max_clusters</span><span class="o">=</span><span class="n">max_clusters</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_site_cluster_analysis</span><span class="p">(</span><span class="n">max_clusters</span><span class="o">=</span><span class="n">max_clusters</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">site_info</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">site_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>
      <span class="k">yield</span> <span class="n">site_info</span>

  <span class="k">def</span> <span class="nf">peak_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span>

  <span class="k">def</span> <span class="nf">special_position_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_position_settings</span>

  <span class="k">def</span> <span class="nf">general_positions_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_positions_only</span>

  <span class="k">def</span> <span class="nf">effective_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effective_resolution</span>

  <span class="k">def</span> <span class="nf">significant_height_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_significant_height_fraction</span>

  <span class="k">def</span> <span class="nf">cluster_height_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_height_fraction</span>

  <span class="k">def</span> <span class="nf">min_cross_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_cross_distance</span>

  <span class="k">def</span> <span class="nf">max_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_clusters</span>

  <span class="k">def</span> <span class="nf">site_cluster_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_cluster_analysis</span>

  <span class="k">def</span> <span class="nf">peak_list_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_indices</span>

  <span class="k">def</span> <span class="nf">fixed_site_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_site_indices</span>

  <span class="k">def</span> <span class="nf">sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span>

  <span class="k">def</span> <span class="nf">heights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heights</span>

  <span class="k">def</span> <span class="nf">max_grid_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">heights</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">append_fixed_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_site_cluster_analysis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_site_cluster_analysis</span><span class="o">.</span><span class="n">insert_fixed_site_frac</span><span class="p">(</span><span class="n">original_site</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_site_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_heights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">discard_last</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_indices</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_site_cluster_analysis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_site_cluster_analysis</span><span class="o">.</span><span class="n">discard_last</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_indices</span><span class="o">.</span><span class="n">pop_back</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">pop_back</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_heights</span><span class="o">.</span><span class="n">pop_back</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">next_site_cluster_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">peak_list_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_index</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">peak_list_index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span> <span class="k">return</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_index</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">site_symmetry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_position_settings</span><span class="o">.</span><span class="n">site_symmetry</span><span class="p">(</span>
        <span class="n">site</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">sites</span><span class="p">()[</span><span class="n">peak_list_index</span><span class="p">])</span>
      <span class="n">site</span> <span class="o">=</span> <span class="n">site_symmetry</span><span class="o">.</span><span class="n">exact_site</span><span class="p">()</span>
      <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_cluster_analysis</span><span class="o">.</span><span class="n">process_site_frac</span><span class="p">(</span>
                <span class="n">original_site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
                <span class="n">site_symmetry_ops</span><span class="o">=</span><span class="n">site_symmetry</span><span class="p">)):</span> <span class="k">continue</span>
      <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">heights</span><span class="p">()[</span><span class="n">peak_list_index</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_list_index</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_heights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">cluster_site_info</span><span class="p">(</span>
        <span class="n">peak_list_index</span><span class="o">=</span><span class="n">peak_list_index</span><span class="p">,</span>
        <span class="n">grid_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">grid_indices</span><span class="p">(</span><span class="n">peak_list_index</span><span class="p">),</span>
        <span class="n">grid_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">grid_heights</span><span class="p">()[</span><span class="n">peak_list_index</span><span class="p">],</span>
        <span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">all_site_cluster_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">max_clusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">max_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_clusters</span>
    <span class="k">assert</span> <span class="n">max_clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">max_clusters</span><span class="p">):</span> <span class="k">break</span>
      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_site_cluster_analysis</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">break</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">next_with_effective_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">peak_list_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_index</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">peak_list_index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span> <span class="k">return</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_index</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_processed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_processed</span><span class="p">[</span><span class="n">peak_list_index</span><span class="p">]):</span> <span class="k">continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_processed</span><span class="p">[</span><span class="n">peak_list_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">grid_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">grid_indices</span><span class="p">(</span><span class="n">peak_list_index</span><span class="p">)</span>
      <span class="n">grid_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">grid_heights</span><span class="p">()[</span><span class="n">peak_list_index</span><span class="p">]</span>
      <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">sites</span><span class="p">()[</span><span class="n">peak_list_index</span><span class="p">]</span>
      <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">heights</span><span class="p">()[</span><span class="n">peak_list_index</span><span class="p">]</span>
      <span class="n">site_symmetry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_position_settings</span><span class="o">.</span><span class="n">site_symmetry</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span>    <span class="bp">self</span><span class="o">.</span><span class="n">_general_positions_only</span>
          <span class="ow">and</span> <span class="ow">not</span> <span class="n">site_symmetry</span><span class="o">.</span><span class="n">is_point_group_1</span><span class="p">()):</span>
        <span class="k">continue</span>
      <span class="n">site</span> <span class="o">=</span> <span class="n">site_symmetry</span><span class="o">.</span><span class="n">exact_site</span><span class="p">()</span>
      <span class="n">equiv_sites</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">sym_equiv_sites</span><span class="p">(</span><span class="n">site_symmetry</span><span class="p">)</span>
      <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
          <span class="n">message</span><span class="o">=</span><span class="s2">&quot;This function should not be used for&quot;</span>
                  <span class="s2">&quot; processing a large number of peaks.&quot;</span><span class="p">,</span>
          <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">min_sym_equiv_distance_info</span><span class="p">(</span><span class="n">equiv_sites</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">dist</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_cross_distance</span><span class="p">):</span>
          <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
          <span class="k">break</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">keep</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>    <span class="bp">self</span><span class="o">.</span><span class="n">_effective_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="p">(</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_heights</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
                 <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_heights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                             <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_significant_height_fraction</span><span class="p">)):</span>
            <span class="n">site</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accumulate_significant</span><span class="p">(</span>
              <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">site_symmetry</span><span class="p">,</span> <span class="n">equiv_sites</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_list_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_heights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_site_info</span><span class="p">(</span>
          <span class="n">peak_list_index</span><span class="o">=</span><span class="n">peak_list_index</span><span class="p">,</span>
          <span class="n">grid_index</span><span class="o">=</span><span class="n">grid_index</span><span class="p">,</span>
          <span class="n">grid_height</span><span class="o">=</span><span class="n">grid_height</span><span class="p">,</span>
          <span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
          <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_accumulate_significant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">site_symmetry</span><span class="p">,</span> <span class="n">equiv_sites</span><span class="p">):</span>
    <span class="n">unit_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_position_settings</span><span class="p">()</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">()</span>
    <span class="n">orth</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">orthogonalize</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">fractionalize</span>
    <span class="n">sum_w_sites</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">orth</span><span class="p">(</span><span class="n">site</span><span class="p">))</span> <span class="o">*</span> <span class="n">height</span>
    <span class="n">sum_w</span> <span class="o">=</span> <span class="n">height</span>
    <span class="n">height_cutoff</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_height_fraction</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_peak_list_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span>
      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_processed</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span> <span class="k">continue</span>
      <span class="n">other_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">heights</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">other_height</span> <span class="o">&lt;</span> <span class="n">height_cutoff</span><span class="p">):</span> <span class="k">break</span>
      <span class="n">other_site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_list</span><span class="o">.</span><span class="n">sites</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">other_site_symmetry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_position_settings</span><span class="o">.</span><span class="n">site_symmetry</span><span class="p">(</span>
        <span class="n">other_site</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span>    <span class="bp">self</span><span class="o">.</span><span class="n">_general_positions_only</span>
          <span class="ow">and</span> <span class="ow">not</span> <span class="n">other_site_symmetry</span><span class="o">.</span><span class="n">is_point_group_1</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_processed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">continue</span>
      <span class="n">other_site</span> <span class="o">=</span> <span class="n">other_site_symmetry</span><span class="o">.</span><span class="n">exact_site</span><span class="p">()</span>
      <span class="n">dist_info</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">min_sym_equiv_distance_info</span><span class="p">(</span><span class="n">equiv_sites</span><span class="p">,</span> <span class="n">other_site</span><span class="p">)</span>
      <span class="n">dist</span> <span class="o">=</span> <span class="n">dist_info</span><span class="o">.</span><span class="n">dist</span><span class="p">()</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_cross_distance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_processed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">close_site</span> <span class="o">=</span> <span class="n">dist_info</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">vec3_double</span><span class="p">([</span><span class="n">other_site</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">close_site</span> <span class="o">=</span> <span class="n">site_symmetry</span><span class="o">.</span><span class="n">special_op</span><span class="p">()</span> <span class="o">*</span> <span class="n">close_site</span>
        <span class="n">sum_w_sites</span> <span class="o">+=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">orth</span><span class="p">(</span><span class="n">close_site</span><span class="p">))</span> <span class="o">*</span> <span class="n">other_height</span>
        <span class="n">sum_w</span> <span class="o">+=</span> <span class="n">other_height</span>
    <span class="k">return</span> <span class="n">frac</span><span class="p">(</span><span class="n">sum_w_sites</span> <span class="o">/</span> <span class="n">sum_w</span><span class="p">),</span> <span class="n">height</span>

  <span class="k">def</span> <span class="nf">all_with_effective_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">max_clusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">max_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_clusters</span>
    <span class="k">assert</span> <span class="n">max_clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">max_clusters</span><span class="p">):</span> <span class="k">break</span>
      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_with_effective_resolution</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">break</span>
    <span class="k">return</span> <span class="bp">self</span>

<span class="k">def</span> <span class="nf">region_density_correlation</span><span class="p">(</span>
      <span class="n">large_unit_cell</span><span class="p">,</span>
      <span class="n">large_d_min</span><span class="p">,</span>
      <span class="n">large_density_map</span><span class="p">,</span>
      <span class="n">sites_cart</span><span class="p">,</span>
      <span class="n">site_radii</span><span class="p">,</span>
      <span class="n">work_scatterers</span><span class="p">):</span>
  <span class="n">sites_frac_large</span> <span class="o">=</span> <span class="n">large_unit_cell</span><span class="o">.</span><span class="n">fractionalize</span><span class="p">(</span><span class="n">sites_cart</span><span class="p">)</span>
  <span class="n">large_frac_min</span> <span class="o">=</span> <span class="n">sites_frac_large</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
  <span class="n">large_frac_max</span> <span class="o">=</span> <span class="n">sites_frac_large</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
  <span class="n">large_n_real</span> <span class="o">=</span> <span class="n">large_density_map</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span>
  <span class="kn">from</span> <span class="nn">scitbx</span> <span class="kn">import</span> <span class="n">fftpack</span>
  <span class="kn">from</span> <span class="nn">libtbx.math_utils</span> <span class="kn">import</span> <span class="n">ifloor</span><span class="p">,</span> <span class="n">iceil</span>
  <span class="n">large_ucp</span> <span class="o">=</span> <span class="n">large_unit_cell</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
  <span class="n">small_n_real</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">small_origin_in_large_grid</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">small_abc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">sites_frac_shift</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">grid_step</span> <span class="o">=</span> <span class="n">large_ucp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">large_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">large_d_min</span> <span class="o">/</span> <span class="n">grid_step</span>
    <span class="n">grid_min</span> <span class="o">=</span> <span class="n">ifloor</span><span class="p">(</span><span class="n">large_frac_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">large_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="n">grid_max</span> <span class="o">=</span> <span class="n">iceil</span><span class="p">(</span><span class="n">large_frac_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">large_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="n">min_grid</span> <span class="o">=</span> <span class="n">grid_max</span> <span class="o">-</span> <span class="n">grid_min</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">small_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">adjust_gridding</span><span class="p">(</span><span class="n">min_grid</span><span class="o">=</span><span class="n">min_grid</span><span class="p">,</span> <span class="n">max_prime</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">small_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">large_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
      <span class="n">shift_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">small_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_grid</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
      <span class="n">small_origin_in_large_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_min</span> <span class="o">-</span> <span class="n">shift_min</span>
      <span class="n">small_abc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_step</span>
      <span class="n">sites_frac_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_origin_in_large_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">large_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">small_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">large_n_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">small_origin_in_large_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">small_abc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">large_ucp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">sites_frac_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">sites_cart_shift</span> <span class="o">=</span> <span class="n">large_unit_cell</span><span class="o">.</span><span class="n">orthogonalize</span><span class="p">(</span><span class="n">sites_frac_shift</span><span class="p">)</span>
  <span class="n">sites_cart_small</span> <span class="o">=</span> <span class="n">sites_cart</span> <span class="o">-</span> <span class="n">sites_cart_shift</span>
  <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">xray</span>
  <span class="n">small_xray_structure</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">structure</span><span class="p">(</span>
    <span class="n">crystal_symmetry</span><span class="o">=</span><span class="n">crystal</span><span class="o">.</span><span class="n">symmetry</span><span class="p">(</span>
      <span class="n">unit_cell</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">small_abc</span><span class="p">)</span><span class="o">+</span><span class="n">large_ucp</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span>
      <span class="n">space_group_symbol</span><span class="o">=</span><span class="s2">&quot;P1&quot;</span><span class="p">),</span>
    <span class="n">scatterers</span><span class="o">=</span><span class="n">work_scatterers</span><span class="p">)</span>
  <span class="n">small_xray_structure</span><span class="o">.</span><span class="n">set_sites_cart</span><span class="p">(</span><span class="n">sites_cart</span><span class="o">=</span><span class="n">sites_cart_small</span><span class="p">)</span>
  <span class="n">small_f_calc</span> <span class="o">=</span> <span class="n">small_xray_structure</span><span class="o">.</span><span class="n">structure_factors</span><span class="p">(</span>
    <span class="n">d_min</span><span class="o">=</span><span class="n">large_d_min</span><span class="p">)</span><span class="o">.</span><span class="n">f_calc</span><span class="p">()</span>
  <span class="n">small_gridding</span> <span class="o">=</span> <span class="n">crystal_gridding</span><span class="p">(</span>
    <span class="n">unit_cell</span><span class="o">=</span><span class="n">small_f_calc</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
    <span class="n">space_group_info</span><span class="o">=</span><span class="n">small_f_calc</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">(),</span>
    <span class="n">pre_determined_n_real</span><span class="o">=</span><span class="n">small_n_real</span><span class="p">)</span>
  <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">miller</span>
  <span class="n">small_fft_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span>
    <span class="n">crystal_gridding</span><span class="o">=</span><span class="n">small_gridding</span><span class="p">,</span>
    <span class="n">fourier_coefficients</span><span class="o">=</span><span class="n">small_f_calc</span><span class="p">)</span>
  <span class="n">small_fft_map</span><span class="o">.</span><span class="n">apply_sigma_scaling</span><span class="p">()</span>
  <span class="n">small_map</span> <span class="o">=</span> <span class="n">small_fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
  <span class="n">grid_indices</span> <span class="o">=</span> <span class="n">grid_indices_around_sites</span><span class="p">(</span>
    <span class="n">unit_cell</span><span class="o">=</span><span class="n">small_xray_structure</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
    <span class="n">fft_n_real</span><span class="o">=</span><span class="n">small_n_real</span><span class="p">,</span>
    <span class="n">fft_m_real</span><span class="o">=</span><span class="n">small_n_real</span><span class="p">,</span>
    <span class="n">sites_cart</span><span class="o">=</span><span class="n">sites_cart_small</span><span class="p">,</span>
    <span class="n">site_radii</span><span class="o">=</span><span class="n">site_radii</span><span class="p">)</span>
  <span class="n">small_copy_from_large_map</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span>
    <span class="n">map_unit_cell</span><span class="o">=</span><span class="n">large_density_map</span><span class="p">,</span>
    <span class="n">first</span><span class="o">=</span><span class="n">small_origin_in_large_grid</span><span class="p">,</span>
    <span class="n">last</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">small_origin_in_large_grid</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">small_n_real</span><span class="p">)</span>
       <span class="o">-</span> <span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
  <span class="k">assert</span> <span class="n">small_copy_from_large_map</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="n">small_map</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
  <span class="n">corr</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">linear_correlation</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">small_map</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">grid_indices</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">small_copy_from_large_map</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">grid_indices</span><span class="p">))</span>
  <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">corr</span><span class="o">.</span><span class="n">is_well_defined</span><span class="p">()):</span>
    <span class="k">return</span> <span class="kc">None</span>
  <span class="k">return</span> <span class="n">corr</span><span class="o">.</span><span class="n">coefficient</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">ccv</span><span class="p">(</span><span class="n">map_1</span><span class="p">,</span> <span class="n">map_2</span><span class="p">,</span> <span class="n">modified</span><span class="p">,</span> <span class="n">centered</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
  <span class="k">if</span><span class="p">(</span><span class="n">modified</span><span class="p">):</span>
    <span class="n">map_1</span> <span class="o">=</span> <span class="n">volume_scale</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">map_1</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span><span class="o">.</span><span class="n">map_data</span><span class="p">()</span>
    <span class="n">map_2</span> <span class="o">=</span> <span class="n">volume_scale</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="n">map_2</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span><span class="o">.</span><span class="n">map_data</span><span class="p">()</span>
  <span class="k">if</span><span class="p">(</span><span class="n">cutoff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">map_1</span> <span class="o">=</span> <span class="n">map_1</span> <span class="o">-</span> <span class="n">cutoff</span>
    <span class="n">map_2</span> <span class="o">=</span> <span class="n">map_2</span> <span class="o">-</span> <span class="n">cutoff</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">map_1</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">map_2</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">map_1</span> <span class="o">=</span> <span class="n">map_1</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">map_2</span> <span class="o">=</span> <span class="n">map_2</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">centered</span><span class="p">):</span>
      <span class="n">s1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="n">s2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">|</span> <span class="n">s2</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">iselection</span><span class="p">()</span>
      <span class="n">x_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="n">y_</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">flex</span><span class="o">.</span><span class="n">linear_correlation</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y_</span><span class="p">,</span>
        <span class="n">subtract_mean</span> <span class="o">=</span> <span class="n">centered</span><span class="p">)</span><span class="o">.</span><span class="n">coefficient</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">corr</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">map_1</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">map_2</span><span class="p">,</span> <span class="n">centered</span> <span class="o">=</span> <span class="n">centered</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">flex</span><span class="o">.</span><span class="n">linear_correlation</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">map_1</span><span class="o">.</span><span class="n">as_1d</span><span class="p">(),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">map_2</span><span class="o">.</span><span class="n">as_1d</span><span class="p">(),</span>
      <span class="n">subtract_mean</span> <span class="o">=</span> <span class="n">centered</span><span class="p">)</span><span class="o">.</span><span class="n">coefficient</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">spherical_variance_around_point</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
      <span class="n">real_map</span><span class="p">,</span>
      <span class="n">unit_cell</span><span class="p">,</span>
      <span class="n">site_cart</span><span class="p">,</span>
      <span class="n">radius</span><span class="p">,</span>
      <span class="n">n_points</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
      <span class="n">spline_interpolation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">write_sphere_points_to_pdb_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">site_cart</span> <span class="o">=</span> <span class="n">site_cart</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>
    <span class="k">assert</span> <span class="n">n_points</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="n">sphere_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">site_cart</span>
    <span class="c1"># reference: &quot;Distributing many points on a sphere&quot; by E.B. Saff and</span>
    <span class="c1">#     A.B.J. Kuijlaars, Mathematical Intelligencer 19.1 (1997) 5--11.</span>
    <span class="c1"># derived from http://packinon.sourceforge.net/py_progs/pg_saff.html</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_points</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">h</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">n_points</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_phi</span> <span class="o">+</span> <span class="mf">3.6</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_points</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">h</span><span class="o">*</span><span class="n">h</span><span class="p">)))</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
      <span class="n">sphere_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
        <span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
        <span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
        <span class="n">z</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="p">))</span>
      <span class="n">old_phi</span> <span class="o">=</span> <span class="n">phi</span>
    <span class="n">map_values</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">sphere_points</span> <span class="p">:</span>
      <span class="n">site_frac</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">fractionalize</span><span class="p">(</span><span class="n">site_cart</span><span class="o">=</span><span class="n">point</span><span class="p">)</span>
      <span class="n">value_at_point</span> <span class="o">=</span> <span class="n">real_map</span><span class="o">.</span><span class="n">tricubic_interpolation</span><span class="p">(</span><span class="n">site_frac</span><span class="p">)</span>
      <span class="n">map_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_at_point</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">map_values</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">map_values</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">map_values</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">standard_deviation</span> <span class="o">=</span> <span class="n">map_values</span><span class="o">.</span><span class="n">standard_deviation_of_the_sample</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write_sphere_points_to_pdb_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">write_sphere_points_to_pdb_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sphere_points</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
          <span class="s2">&quot;HETATM    1  O   HOH A   1     </span><span class="si">%7.3f</span><span class="s2"> </span><span class="si">%7.3f</span><span class="s2"> </span><span class="si">%7.3f</span><span class="s2">  1.00 20.00</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span>
          <span class="n">point</span><span class="p">)</span>
      <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span> <span class="n">out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">Map values around point [</span><span class="si">%g</span><span class="s2">, </span><span class="si">%g</span><span class="s2">, </span><span class="si">%g</span><span class="s2">], radius=</span><span class="si">%g</span><span class="s2">:&quot;</span> <span class="o">%</span> \
      <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_cart</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_cart</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_cart</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">  min=</span><span class="si">%.2f</span><span class="s2">  max=</span><span class="si">%.2f</span><span class="s2">  mean=</span><span class="si">%.2f</span><span class="s2">  stddev=</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> \
      <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard_deviation</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">principal_axes_of_inertia</span><span class="p">(</span>
    <span class="n">real_map</span><span class="p">,</span>
    <span class="n">site_cart</span><span class="p">,</span>
    <span class="n">unit_cell</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">):</span>
  <span class="n">st</span> <span class="o">=</span> <span class="n">sphericity_tensor</span><span class="p">(</span>
    <span class="n">map_data</span>  <span class="o">=</span> <span class="n">real_map</span><span class="p">,</span>
    <span class="n">unit_cell</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="p">,</span>
    <span class="n">radius</span>    <span class="o">=</span> <span class="n">radius</span><span class="p">,</span>
    <span class="n">site_frac</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">fractionalize</span><span class="p">(</span><span class="n">site_cart</span><span class="p">))</span>
  <span class="n">es</span> <span class="o">=</span> <span class="n">adptbx</span><span class="o">.</span><span class="n">eigensystem</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">center_of_mass_</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">center_of_mass</span><span class="p">(</span>
    <span class="n">map_data</span><span class="o">=</span><span class="n">real_map</span><span class="p">,</span> <span class="n">unit_cell</span><span class="o">=</span><span class="n">unit_cell</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">inertia_tensor</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">st</span>
  <span class="k">def</span> <span class="nf">eigensystem</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">es</span>
  <span class="k">return</span> <span class="n">group_args</span><span class="p">(</span>
    <span class="n">center_of_mass</span> <span class="o">=</span> <span class="n">center_of_mass_</span><span class="p">,</span>
    <span class="n">inertia_tensor</span> <span class="o">=</span> <span class="n">inertia_tensor</span><span class="p">,</span>
    <span class="n">eigensystem</span>    <span class="o">=</span> <span class="n">eigensystem</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">local_scale</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">crystal_gridding</span><span class="p">,</span>
        <span class="n">crystal_symmetry</span><span class="p">,</span>
        <span class="n">f_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">map_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">miller_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">d_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1">#XXX =1: more features and noise</span>
    <span class="c1"># process inputs</span>
    <span class="k">assert</span> <span class="p">[</span><span class="n">f_map</span><span class="p">,</span> <span class="n">map_data</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">if</span><span class="p">(</span><span class="n">f_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="kn">import</span> <span class="nn">cctbx.miller</span>
      <span class="n">fft_map</span> <span class="o">=</span> <span class="n">cctbx</span><span class="o">.</span><span class="n">miller</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span>
        <span class="n">crystal_gridding</span>     <span class="o">=</span> <span class="n">crystal_gridding</span><span class="p">,</span>
        <span class="n">fourier_coefficients</span> <span class="o">=</span> <span class="n">f_map</span><span class="p">)</span>
      <span class="n">fft_map</span><span class="o">.</span><span class="n">apply_sigma_scaling</span><span class="p">()</span>
      <span class="n">map_data</span> <span class="o">=</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">map_result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">map_coefficients</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">(</span>
      <span class="n">n_real</span>   <span class="o">=</span> <span class="n">crystal_gridding</span><span class="o">.</span><span class="n">n_real</span><span class="p">(),</span>
      <span class="n">fraction</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">)</span>
    <span class="c1"># Loop over boxes, fill map_result with one box at a time</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">map_result</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">n_real</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">starts</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ends</span><span class="p">):</span>
      <span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
      <span class="n">box</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
      <span class="n">mi</span><span class="p">,</span><span class="n">ma</span><span class="p">,</span><span class="n">me</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span><span class="o">.</span><span class="n">min_max_mean</span><span class="p">()</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span>
      <span class="k">if</span><span class="p">(</span><span class="n">mi</span> <span class="o">&lt;</span> <span class="n">ma</span><span class="p">):</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">volume_scale</span><span class="p">(</span><span class="nb">map</span> <span class="o">=</span> <span class="n">box</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">map_data</span><span class="p">()</span>
      <span class="n">set_box</span><span class="p">(</span>
        <span class="n">map_data_from</span> <span class="o">=</span> <span class="n">box</span><span class="p">,</span>
        <span class="n">map_data_to</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_result</span><span class="p">,</span>
        <span class="n">start</span>         <span class="o">=</span> <span class="n">s</span><span class="p">,</span>
        <span class="n">end</span>           <span class="o">=</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_result</span><span class="o">.</span><span class="n">sample_standard_deviation</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">map_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_result</span><span class="o">/</span><span class="n">sd</span>
    <span class="k">if</span><span class="p">(</span><span class="n">miller_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">complete_set</span> <span class="o">=</span> <span class="n">miller_array</span>
      <span class="k">if</span><span class="p">(</span><span class="n">d_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">d_min</span> <span class="o">=</span> <span class="n">miller_array</span><span class="o">.</span><span class="n">d_min</span><span class="p">()</span>
        <span class="n">complete_set</span> <span class="o">=</span> <span class="n">miller_array</span><span class="o">.</span><span class="n">complete_set</span><span class="p">(</span><span class="n">d_min</span><span class="o">=</span><span class="n">d_min</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">map_coefficients</span> <span class="o">=</span> <span class="n">complete_set</span><span class="o">.</span><span class="n">structure_factors_from_map</span><span class="p">(</span>
        <span class="nb">map</span>            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_result</span><span class="p">,</span>
        <span class="n">use_scale</span>      <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">anomalous_flag</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_sg</span>         <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">map_peak_3d_as_2d</span><span class="p">(</span>
      <span class="n">map_data</span><span class="p">,</span>
      <span class="n">unit_cell</span><span class="p">,</span>
      <span class="n">center_cart</span><span class="p">,</span>
      <span class="n">radius</span><span class="p">,</span>
      <span class="n">step</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
      <span class="n">s_angle_sampling_step</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
      <span class="n">t_angle_sampling_step</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
  <span class="n">rho_1d</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
  <span class="n">dist</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
  <span class="n">radius</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
  <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">step</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="mf">100.</span>
    <span class="n">dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="n">s_angle_sampling_step</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="n">t_angle_sampling_step</span><span class="p">):</span>
        <span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">,</span><span class="n">zc</span> <span class="o">=</span> <span class="n">scitbx</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">point_on_sphere</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">s_deg</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">t_deg</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
          <span class="n">center</span><span class="o">=</span><span class="n">center_cart</span><span class="p">)</span>
        <span class="n">xf</span><span class="p">,</span><span class="n">yf</span><span class="p">,</span><span class="n">zf</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">fractionalize</span><span class="p">([</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">,</span><span class="n">zc</span><span class="p">])</span>
        <span class="n">rho</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_data</span><span class="o">.</span><span class="n">eight_point_interpolation</span><span class="p">([</span><span class="n">xf</span><span class="p">,</span><span class="n">yf</span><span class="p">,</span><span class="n">zf</span><span class="p">]))</span>
        <span class="c1">#rho.append(map_data.tricubic_interpolation([xf,yf,zf]))</span>
    <span class="n">rho_1d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rho</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">dist</span><span class="p">,</span> <span class="n">rho_1d</span>

<span class="k">class</span> <span class="nc">positivity_constrained_density_modification</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f_000</span><span class="p">,</span> <span class="n">n_cycles</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">resolution_factor</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">d_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">crystal_gridding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complete_set</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">=</span> <span class="n">d_min</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">crystal_gridding</span> <span class="o">=</span> <span class="n">crystal_gridding</span>
    <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">miller</span>
    <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">d_min</span><span class="p">()</span>
    <span class="k">if</span><span class="p">(</span><span class="n">complete_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">complete_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">complete_set</span><span class="p">(</span><span class="n">d_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_min</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crystal_gridding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">crystal_gridding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">crystal_gridding</span><span class="p">(</span>
        <span class="n">d_min</span>                   <span class="o">=</span> <span class="n">d_min</span><span class="p">,</span>
        <span class="n">resolution_factor</span>       <span class="o">=</span> <span class="n">resolution_factor</span><span class="p">,</span>
        <span class="n">grid_step</span>               <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">symmetry_flags</span>          <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mandatory_factors</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_prime</span>               <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">assert_shannon_sampling</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">f_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cycles</span><span class="p">):</span>
      <span class="n">fft_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span>
        <span class="n">crystal_gridding</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crystal_gridding</span><span class="p">,</span>
        <span class="n">fourier_coefficients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_mod</span><span class="p">,</span>
        <span class="n">f_000</span>                <span class="o">=</span> <span class="n">f_000</span><span class="p">)</span>
      <span class="k">if</span><span class="p">(</span><span class="n">f_000</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">apply_volume_scaling</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
      <span class="n">convert_to_non_negative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">f_mod</span> <span class="o">=</span> <span class="n">complete_set</span><span class="o">.</span><span class="n">structure_factors_from_map</span><span class="p">(</span>
        <span class="nb">map</span>            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span>
        <span class="n">use_scale</span>      <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">anomalous_flag</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_sg</span>         <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">f_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">complete_with</span><span class="p">(</span><span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_mod</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">replace_phases</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="c1">#self.assert_equal()</span>

  <span class="k">def</span> <span class="nf">assert_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">libtbx.test_utils</span> <span class="kn">import</span> <span class="n">approx_equal</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_mod</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">common_sets</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">approx_equal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">d_min_corner</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">unit_cell</span><span class="p">):</span>
  <span class="n">max_index</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">miller_index</span><span class="p">(</span> <span class="p">[[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">map_data</span><span class="o">.</span><span class="n">all</span><span class="p">()]]</span> <span class="p">)</span>
  <span class="k">return</span> <span class="n">uctbx</span><span class="o">.</span><span class="n">d_star_sq_as_d</span><span class="p">(</span><span class="n">unit_cell</span><span class="o">.</span><span class="n">max_d_star_sq</span><span class="p">(</span> <span class="n">max_index</span> <span class="p">))</span>

<span class="k">def</span> <span class="nf">d_min_from_map</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">unit_cell</span><span class="p">,</span> <span class="n">resolution_factor</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">parameters</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
  <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
  <span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">d3</span> <span class="o">=</span> \
    <span class="n">a</span><span class="o">/</span><span class="n">nx</span><span class="o">/</span><span class="n">resolution_factor</span><span class="p">,</span>\
    <span class="n">b</span><span class="o">/</span><span class="n">ny</span><span class="o">/</span><span class="n">resolution_factor</span><span class="p">,</span>\
    <span class="n">c</span><span class="o">/</span><span class="n">nz</span><span class="o">/</span><span class="n">resolution_factor</span>
  <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">d3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">map_to_map_coefficients</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">d_min</span><span class="p">):</span>
  <span class="kn">import</span> <span class="nn">cctbx.miller</span>
  <span class="n">fft</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">real_to_complex_3d</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span>
  <span class="n">map_box</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">flex</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">m_real</span><span class="p">())</span><span class="o">.</span><span class="n">set_focus</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">focus</span><span class="p">()))</span>
  <span class="n">map_box</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">m_real</span><span class="p">())</span><span class="o">.</span><span class="n">set_focus</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">n_real</span><span class="p">()))</span>
  <span class="n">map_box</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">map_box</span><span class="p">)</span>
  <span class="n">box_structure_factors</span> <span class="o">=</span> <span class="n">structure_factors</span><span class="o">.</span><span class="n">from_map</span><span class="p">(</span>
    <span class="n">unit_cell</span><span class="o">=</span><span class="n">cs</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
    <span class="n">space_group_type</span><span class="o">=</span><span class="n">cs</span><span class="o">.</span><span class="n">space_group</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>
    <span class="n">anomalous_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">d_min</span><span class="o">=</span><span class="n">d_min</span><span class="p">,</span>
    <span class="n">complex_map</span><span class="o">=</span><span class="n">map_box</span><span class="p">,</span>
    <span class="n">conjugate_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">discard_indices_affected_by_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">map_box</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">map_box</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">map_box</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">map_coeffs</span> <span class="o">=</span> <span class="n">cctbx</span><span class="o">.</span><span class="n">miller</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">crystal_symmetry</span><span class="o">=</span><span class="n">cs</span><span class="p">,</span>
    <span class="n">anomalous_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">indices</span><span class="o">=</span><span class="n">box_structure_factors</span><span class="o">.</span><span class="n">miller_indices</span><span class="p">(),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">box_structure_factors</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">map_coeffs</span>

<span class="k">def</span> <span class="nf">atom_radius_as_central_peak_width</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">,</span> <span class="n">d_min</span><span class="p">,</span> <span class="n">scattering_table</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Estimate atom radius as half-width of the central peak of Fourier image.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">xray</span><span class="p">,</span> <span class="n">miller</span>
  <span class="n">dim</span> <span class="o">=</span> <span class="mf">40.</span>
  <span class="n">cs</span> <span class="o">=</span> <span class="n">crystal</span><span class="o">.</span><span class="n">symmetry</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="s2">&quot;P 1&quot;</span><span class="p">)</span>
  <span class="n">sp</span> <span class="o">=</span> <span class="n">crystal</span><span class="o">.</span><span class="n">special_position_settings</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
  <span class="n">sc</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">scatterer</span><span class="p">(</span>
    <span class="n">scattering_type</span> <span class="o">=</span> <span class="n">element</span><span class="p">,</span>
    <span class="n">site</span>            <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">u</span>               <span class="o">=</span> <span class="n">adptbx</span><span class="o">.</span><span class="n">b_as_u</span><span class="p">(</span><span class="n">b_iso</span><span class="p">))</span>
  <span class="n">scatterers</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">xray_scatterer</span><span class="p">([</span><span class="n">sc</span><span class="p">])</span>
  <span class="n">xrs</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">structure</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">scatterers</span><span class="p">)</span>
  <span class="n">xrs</span><span class="o">.</span><span class="n">scattering_type_registry</span><span class="p">(</span><span class="n">table</span> <span class="o">=</span> <span class="n">scattering_table</span><span class="p">)</span>
  <span class="n">cg</span> <span class="o">=</span> <span class="n">crystal_gridding</span><span class="p">(</span>
    <span class="n">unit_cell</span>         <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
    <span class="n">space_group_info</span>  <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">(),</span>
    <span class="n">step</span>              <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
  <span class="n">fc</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">structure_factors</span><span class="p">(</span><span class="n">d_min</span> <span class="o">=</span> <span class="n">d_min</span><span class="p">,</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;direct&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">f_calc</span><span class="p">()</span>
  <span class="n">fft_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span>
    <span class="n">crystal_gridding</span>     <span class="o">=</span> <span class="n">cg</span><span class="p">,</span>
    <span class="n">fourier_coefficients</span> <span class="o">=</span> <span class="n">fc</span><span class="p">,</span>
    <span class="n">f_000</span>                <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">f_000</span><span class="p">())</span>
  <span class="n">fft_map</span><span class="o">.</span><span class="n">apply_volume_scaling</span><span class="p">()</span>
  <span class="n">map_data</span> <span class="o">=</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
  <span class="k">def</span> <span class="nf">search_curve</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">mv_max</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">mv_prev</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">while</span> <span class="n">x</span><span class="o">&lt;=</span><span class="n">dim</span><span class="p">:</span>
      <span class="n">mv</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">eight_point_interpolation</span><span class="p">([</span><span class="n">x</span><span class="o">/</span><span class="n">dim</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">if</span><span class="p">(</span><span class="n">mv_prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mv</span><span class="o">&gt;</span><span class="n">mv_prev</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="n">step</span>
      <span class="k">if</span><span class="p">(</span><span class="n">mv_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="n">mv_max</span><span class="o">=</span><span class="n">mv</span>
      <span class="k">if</span><span class="p">(</span><span class="n">mv_max</span><span class="o">/</span><span class="n">mv</span><span class="o">&gt;</span><span class="mf">100.</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="n">step</span>
      <span class="k">if</span><span class="p">(</span><span class="n">mv</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">):</span>          <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="n">step</span>
      <span class="n">x</span><span class="o">+=</span><span class="n">step</span>
      <span class="n">mv_prev</span> <span class="o">=</span> <span class="n">mv</span>
    <span class="k">return</span> <span class="kc">None</span>
  <span class="n">radius</span> <span class="o">=</span> <span class="n">search_curve</span><span class="p">(</span><span class="n">map_data</span><span class="o">=</span><span class="n">map_data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
  <span class="k">return</span> <span class="n">radius</span>

<span class="k">class</span> <span class="nc">atom_curves</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Class-toolkit to compute various 1-atom 1D curves: exact electron density,</span>
<span class="sd">Fourier image of specified resolution, etc.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scattering_type</span><span class="p">,</span> <span class="n">scattering_table</span><span class="o">=</span><span class="s2">&quot;wk1995&quot;</span><span class="p">):</span>
    <span class="n">adopt_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xray_structure</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">scattering_type_registry</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">unique_form_factors_at_d_star_sq</span>

  <span class="k">def</span> <span class="nf">get_xray_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">crystal</span><span class="o">.</span><span class="n">symmetry</span><span class="p">((</span><span class="n">box</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="s2">&quot;P 1&quot;</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">crystal</span><span class="o">.</span><span class="n">special_position_settings</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">xray</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">scatterer</span><span class="p">(</span>
      <span class="n">scattering_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scattering_type</span><span class="p">,</span>
      <span class="n">site</span>            <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="n">u</span>               <span class="o">=</span> <span class="n">adptbx</span><span class="o">.</span><span class="n">b_as_u</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="n">scatterers</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">xray_scatterer</span><span class="p">([</span><span class="n">sc</span><span class="p">])</span>
    <span class="n">xrs</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">structure</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">scatterers</span><span class="p">)</span>
    <span class="n">xrs</span><span class="o">.</span><span class="n">scattering_type_registry</span><span class="p">(</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scattering_table</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xrs</span>

  <span class="k">def</span> <span class="nf">exact_density_at_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scattering_type</span><span class="p">)</span><span class="o">.</span><span class="n">electron_density</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">exact_gradient_at_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scattering_type</span><span class="p">)</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span>
      <span class="n">b_iso</span><span class="o">=</span><span class="n">b_iso</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">exact_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">,</span> <span class="n">radius_max</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">radius_step</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">density</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">radii</span>   <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scr</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scattering_type</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">radius_max</span><span class="p">:</span>
      <span class="n">density</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">electron_density</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">))</span>
      <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
      <span class="n">r</span><span class="o">+=</span><span class="n">radius_step</span>
    <span class="k">return</span> <span class="n">group_args</span><span class="p">(</span><span class="n">radii</span> <span class="o">=</span> <span class="n">radii</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="n">density</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">form_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">):</span>
    <span class="n">dss</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">ss</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uff</span><span class="p">(</span><span class="n">dss</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b_iso</span><span class="o">*</span><span class="n">ss</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">integrand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
      <span class="n">ss</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1.e-9</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span><span class="o">/</span><span class="n">r</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_factor</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_factor</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compute</span>

  <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">d_min</span><span class="p">,</span>
            <span class="n">b_iso</span><span class="p">,</span>
            <span class="n">d_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">radius_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">radius_max</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
            <span class="n">radius_step</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">n_integration_steps</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">radius_min</span>
    <span class="k">assert</span> <span class="n">d_max</span> <span class="o">!=</span> <span class="mf">0.</span>
    <span class="k">if</span><span class="p">(</span><span class="n">d_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="n">s_min</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>              <span class="n">s_min</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">d_max</span>
    <span class="k">assert</span> <span class="n">d_min</span> <span class="o">!=</span> <span class="mf">0.</span>
    <span class="n">s_max</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">d_min</span>
    <span class="n">image_values</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">radii</span>        <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">radius_max</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">scitbx</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">simpson</span><span class="p">(</span>
        <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">integrand</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">),</span> <span class="n">a</span><span class="o">=</span><span class="n">s_min</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">s_max</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_integration_steps</span><span class="p">)</span>
      <span class="n">image_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
      <span class="n">r</span><span class="o">+=</span><span class="n">radius_step</span>
    <span class="c1"># Fine first inflection point</span>
    <span class="n">first_inflection_point</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">i_first_inflection_point</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">image_values</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">second_derivatives</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
      <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dxx</span> <span class="o">=</span> <span class="n">image_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">image_values</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">image_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="k">elif</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">dxx</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">image_values</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">image_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">dxx</span> <span class="o">=</span> <span class="n">second_derivatives</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">radius_step</span><span class="o">**</span><span class="mi">2</span>
      <span class="k">if</span><span class="p">(</span><span class="n">first_inflection_point</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dxx</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">first_inflection_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">i_first_inflection_point</span><span class="o">=</span><span class="n">i</span>
      <span class="n">second_derivatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dxx</span><span class="o">/</span><span class="n">radius_step</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">group_args</span><span class="p">(</span>
      <span class="n">radii</span>                    <span class="o">=</span> <span class="n">radii</span><span class="p">,</span>
      <span class="n">image_values</span>             <span class="o">=</span> <span class="n">image_values</span><span class="p">,</span>
      <span class="n">first_inflection_point</span>   <span class="o">=</span> <span class="n">first_inflection_point</span><span class="p">,</span>
      <span class="n">i_first_inflection_point</span> <span class="o">=</span> <span class="n">i_first_inflection_point</span><span class="p">,</span>
      <span class="n">radius</span>                   <span class="o">=</span> <span class="n">first_inflection_point</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
      <span class="n">second_derivatives</span>       <span class="o">=</span> <span class="n">second_derivatives</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">image_from_miller_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">miller_indices</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">,</span> <span class="n">uc</span><span class="p">,</span>
                                <span class="n">radius_max</span><span class="p">,</span> <span class="n">radius_step</span><span class="p">):</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">miller_indices</span><span class="p">:</span>
      <span class="n">p2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form_factor</span><span class="p">(</span><span class="n">ss</span><span class="o">=</span><span class="n">uc</span><span class="o">.</span><span class="n">d_star_sq</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">b_iso</span><span class="o">=</span><span class="n">b_iso</span><span class="p">))</span>
      <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">mi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">mv</span>  <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">z</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">while</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">radius_max</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">mi</span><span class="p">,</span> <span class="n">p2i</span><span class="p">,</span> <span class="n">tmpi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">miller_indices</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">p2i</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tmpi</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
      <span class="n">rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
      <span class="n">mv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">z</span><span class="o">+=</span><span class="n">radius_step</span>
    <span class="k">return</span> <span class="n">group_args</span><span class="p">(</span><span class="n">radii</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span> <span class="n">image_values</span><span class="o">=</span><span class="n">mv</span><span class="o">/</span><span class="n">uc</span><span class="o">.</span><span class="n">volume</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">image_from_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">unit_cell</span><span class="p">,</span> <span class="n">space_group_info</span><span class="p">,</span>
                          <span class="n">miller_array</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">miller</span>
    <span class="n">xrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xray_structure</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">miller_array</span><span class="o">.</span><span class="n">structure_factors_from_scatterers</span><span class="p">(</span>
      <span class="n">xray_structure</span> <span class="o">=</span> <span class="n">xrs</span><span class="p">,</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;direct&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">f_calc</span><span class="p">()</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="n">crystal_gridding</span><span class="p">(</span>
      <span class="n">unit_cell</span>         <span class="o">=</span> <span class="n">unit_cell</span><span class="p">,</span>
      <span class="n">space_group_info</span>  <span class="o">=</span> <span class="n">space_group_info</span><span class="p">,</span>
      <span class="n">step</span>              <span class="o">=</span> <span class="n">step</span><span class="p">,</span>
      <span class="n">symmetry_flags</span>    <span class="o">=</span> <span class="n">use_space_group_symmetry</span><span class="p">)</span>
    <span class="n">fft_map</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span>
      <span class="n">crystal_gridding</span>     <span class="o">=</span> <span class="n">cg</span><span class="p">,</span>
      <span class="n">fourier_coefficients</span> <span class="o">=</span> <span class="n">fc</span><span class="p">)</span>
    <span class="n">fft_map</span><span class="o">.</span><span class="n">apply_volume_scaling</span><span class="p">()</span>
    <span class="n">map_data</span> <span class="o">=</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
    <span class="n">mv</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">box</span><span class="p">:</span>
      <span class="n">mv_</span> <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">eight_point_interpolation</span><span class="p">([</span><span class="n">r</span><span class="o">/</span><span class="n">box</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">mv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mv_</span><span class="p">)</span>
      <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
      <span class="n">r</span><span class="o">+=</span><span class="n">step</span>
    <span class="k">return</span> <span class="n">group_args</span><span class="p">(</span><span class="n">radii</span><span class="o">=</span><span class="n">radii</span><span class="p">,</span> <span class="n">image_values</span><span class="o">=</span><span class="n">mv</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">one_gaussian_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">cmn</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">B0</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A0</span><span class="o">*</span><span class="n">cmn</span><span class="o">**</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">cmn</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">one_gaussian_approximation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_min</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">use_inflection_point</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ib0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">(</span>
      <span class="n">d_min</span> <span class="o">=</span> <span class="n">d_min</span><span class="p">,</span> <span class="n">b_iso</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius_max</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">radius_step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">use_inflection_point</span><span class="p">):</span>
      <span class="n">i_cut</span> <span class="o">=</span> <span class="n">ib0</span><span class="o">.</span><span class="n">i_first_inflection_point</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">i_cut</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">ib0</span><span class="o">.</span><span class="n">radii</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ib0</span><span class="o">.</span><span class="n">image_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">):</span>
          <span class="n">rad_cut</span> <span class="o">=</span> <span class="n">ib0</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">i_cut</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
          <span class="k">break</span>
    <span class="k">assert</span> <span class="n">i_cut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="c1"># this gives a*exp(-b*x**2)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">scitbx</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">gaussian_fit_1d_analytical</span><span class="p">(</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">ib0</span><span class="o">.</span><span class="n">radii</span><span class="p">[:</span><span class="n">i_cut</span><span class="p">],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ib0</span><span class="o">.</span><span class="n">image_values</span><span class="p">[:</span><span class="n">i_cut</span><span class="p">])</span>
    <span class="n">B0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">r</span><span class="o">.</span><span class="n">b</span>
    <span class="n">A0</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">b</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span>
    <span class="n">image_approx_values</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">ib0</span><span class="o">.</span><span class="n">radii</span><span class="p">:</span>
      <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_gaussian_exact</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span> <span class="n">A0</span><span class="o">=</span><span class="n">A0</span><span class="p">,</span> <span class="n">B0</span><span class="o">=</span><span class="n">B0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
      <span class="n">image_approx_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">group_args</span><span class="p">(</span><span class="n">image_b0</span><span class="o">=</span><span class="n">ib0</span><span class="p">,</span> <span class="n">image_approx_at_b</span> <span class="o">=</span> <span class="n">image_approx_values</span><span class="p">,</span>
      <span class="n">i_cut</span> <span class="o">=</span> <span class="n">i_cut</span><span class="p">,</span> <span class="n">n_points</span> <span class="o">=</span> <span class="n">ib0</span><span class="o">.</span><span class="n">radii</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">sharpen2</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">xray_structure</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">file_name_prefix</span><span class="p">):</span>
  <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">miller</span>
  <span class="n">fo</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">structure_factor_box_from_map</span><span class="p">(</span>
    <span class="n">crystal_symmetry</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">(),</span> <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span><span class="p">)</span>
  <span class="c1">#</span>
  <span class="n">fc</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">structure_factors_from_scatterers</span><span class="p">(</span>
    <span class="n">xray_structure</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="p">)</span><span class="o">.</span><span class="n">f_calc</span><span class="p">()</span>
  <span class="n">d_fsc_model</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">d_min_from_fsc</span><span class="p">(</span>
        <span class="n">other</span><span class="o">=</span><span class="n">fo</span><span class="p">,</span> <span class="n">bin_width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fsc_cutoff</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">d_min</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;d_fsc_model:&quot;</span><span class="p">,</span> <span class="n">d_fsc_model</span><span class="p">)</span>
  <span class="c1">#resolution = min(resolution, d_fsc_model)</span>
  <span class="c1">#resolution = d_fsc_model</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">d_fsc_model</span><span class="p">)</span>
  <span class="c1">#</span>
  <span class="n">xray_structure</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="o">.</span><span class="n">set_b_iso</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">fc</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">structure_factors_from_scatterers</span><span class="p">(</span>
    <span class="n">xray_structure</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="p">)</span><span class="o">.</span><span class="n">f_calc</span><span class="p">()</span>
  <span class="n">d_spacings</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
  <span class="c1">#</span>
  <span class="n">cc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
  <span class="n">d_best</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mf">10.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">)]:</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">d_spacings</span><span class="o">&lt;</span><span class="n">d</span>
    <span class="n">data_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">fc_</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">customized_copy</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_</span><span class="p">)</span>
    <span class="n">cc_</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">map_correlation</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">fc_</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cc_</span><span class="o">&gt;</span><span class="n">cc</span><span class="p">):</span>
      <span class="n">cc</span> <span class="o">=</span> <span class="n">cc_</span>
      <span class="n">d_best</span> <span class="o">=</span> <span class="n">d</span>
    <span class="c1">#print &quot;%8.1f %10.6f&quot;%(d, cc_)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best d:&quot;</span><span class="p">,</span> <span class="n">d_best</span><span class="p">)</span>
  <span class="c1">#</span>
  <span class="n">fc1</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="o">.</span><span class="n">structure_factors</span><span class="p">(</span><span class="n">d_min</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span><span class="o">.</span><span class="n">f_calc</span><span class="p">()</span>
  <span class="n">fc2</span> <span class="o">=</span> <span class="n">fc1</span><span class="o">.</span><span class="n">resolution_filter</span><span class="p">(</span><span class="n">d_min</span><span class="o">=</span><span class="n">d_best</span><span class="p">)</span>
  <span class="n">cg</span> <span class="o">=</span> <span class="n">crystal_gridding</span><span class="p">(</span>
    <span class="n">unit_cell</span>        <span class="o">=</span> <span class="n">xray_structure</span><span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">()</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
    <span class="n">space_group_info</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">()</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">(),</span>
    <span class="n">d_min</span>            <span class="o">=</span> <span class="n">resolution</span><span class="p">)</span>
  <span class="n">map2</span> <span class="o">=</span> <span class="n">fc2</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span><span class="n">crystal_gridding</span><span class="o">=</span><span class="n">cg</span><span class="p">)</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
  <span class="n">cc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
  <span class="n">b</span><span class="o">=</span><span class="kc">None</span>
  <span class="n">ss</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">fc1</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">())</span> <span class="o">/</span> <span class="mf">4.</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">fc1</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">b_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">xray_structure</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="o">.</span><span class="n">set_b_iso</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">b_</span><span class="p">)</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b_</span><span class="o">*</span><span class="n">ss</span><span class="p">)</span>
    <span class="n">fc1</span> <span class="o">=</span> <span class="n">fc1</span><span class="o">.</span><span class="n">customized_copy</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">*</span><span class="n">sc</span><span class="p">)</span>
    <span class="n">map1</span> <span class="o">=</span> <span class="n">fc1</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span><span class="n">crystal_gridding</span><span class="o">=</span><span class="n">cg</span><span class="p">)</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
    <span class="n">cc_</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">linear_correlation</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">map1</span><span class="o">.</span><span class="n">as_1d</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">map2</span><span class="o">.</span><span class="n">as_1d</span><span class="p">())</span><span class="o">.</span><span class="n">coefficient</span><span class="p">()</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cc_</span><span class="o">&gt;</span><span class="n">cc</span><span class="p">):</span>
      <span class="n">cc</span> <span class="o">=</span> <span class="n">cc_</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">b_</span>
    <span class="c1">#print &quot;%8.0f %10.6f&quot;%(b_, cc_)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best B:&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="c1">#</span>
  <span class="n">fo_sharp</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">resolution_filter</span><span class="p">(</span><span class="n">d_min</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">)</span>
  <span class="n">ss</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">fo_sharp</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">())</span> <span class="o">/</span> <span class="mf">4.</span>
  <span class="c1">#B_sharp = -35.</span>
  <span class="n">B_sharp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">b</span>
  <span class="n">sc</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">B_sharp</span><span class="o">*</span><span class="n">ss</span><span class="p">)</span>
  <span class="n">fo_sharp</span> <span class="o">=</span> <span class="n">fo_sharp</span><span class="o">.</span><span class="n">customized_copy</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">fo_sharp</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">*</span><span class="n">sc</span><span class="p">)</span>
  <span class="c1"># output</span>
  <span class="n">mtz_dataset</span> <span class="o">=</span> <span class="n">fo_sharp</span><span class="o">.</span><span class="n">as_mtz_dataset</span><span class="p">(</span><span class="n">column_root_label</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
  <span class="n">mtz_object</span> <span class="o">=</span> <span class="n">mtz_dataset</span><span class="o">.</span><span class="n">mtz_object</span><span class="p">()</span>
  <span class="n">mtz_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.mtz&quot;</span><span class="o">%</span><span class="n">file_name_prefix</span><span class="p">)</span>
  <span class="n">fft_map</span> <span class="o">=</span> <span class="n">fo_sharp</span><span class="o">.</span><span class="n">fft_map</span><span class="p">(</span><span class="n">crystal_gridding</span> <span class="o">=</span> <span class="n">cg</span><span class="p">)</span>
  <span class="n">fft_map</span><span class="o">.</span><span class="n">apply_sigma_scaling</span><span class="p">()</span>
  <span class="n">map_data</span> <span class="o">=</span> <span class="n">fft_map</span><span class="o">.</span><span class="n">real_map_unpadded</span><span class="p">()</span>
  <span class="c1">#</span>
  <span class="kn">import</span> <span class="nn">mmtbx.masks</span>
  <span class="n">mask_object</span> <span class="o">=</span> <span class="n">mmtbx</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">smooth_mask</span><span class="p">(</span>
    <span class="n">xray_structure</span> <span class="o">=</span> <span class="n">xray_structure</span><span class="p">,</span>
    <span class="n">n_real</span>         <span class="o">=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
    <span class="n">rad_smooth</span>     <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span>
  <span class="n">map_data</span> <span class="o">=</span> <span class="n">map_data</span> <span class="o">*</span> <span class="n">mask_object</span><span class="o">.</span><span class="n">mask_smooth</span>
  <span class="c1">#</span>
  <span class="kn">from</span> <span class="nn">iotbx</span> <span class="kn">import</span> <span class="n">mrcfile</span>
  <span class="n">mrcfile</span><span class="o">.</span><span class="n">write_ccp4_map</span><span class="p">(</span>
    <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.ccp4&quot;</span><span class="o">%</span><span class="n">file_name_prefix</span><span class="p">,</span>
    <span class="n">unit_cell</span><span class="o">=</span><span class="n">cg</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
    <span class="n">space_group</span><span class="o">=</span><span class="n">cg</span><span class="o">.</span><span class="n">space_group</span><span class="p">(),</span>
    <span class="c1">#gridding_first=(0,0,0),# This causes a bug (map gets shifted)</span>
    <span class="c1">#gridding_last=n_real,  # This causes a bug (map gets shifted)</span>
    <span class="n">map_data</span><span class="o">=</span><span class="n">map_data</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">flex</span><span class="o">.</span><span class="n">std_string</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]))</span>
  <span class="k">return</span> <span class="n">fo_sharp</span><span class="p">,</span> <span class="n">map_data</span>

<span class="k">def</span> <span class="nf">loc_res</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span>
            <span class="n">pdb_hierarchy</span><span class="p">,</span>
            <span class="n">crystal_symmetry</span><span class="p">,</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">soft_mask_radius</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fsc&quot;</span><span class="p">,</span>
            <span class="n">hard_d_min</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">b_range_low</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">b_range_high</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">fsc_cutoff</span><span class="o">=</span><span class="mf">0.143</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
  <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fsc&quot;</span><span class="p">,</span> <span class="s2">&quot;rscc&quot;</span><span class="p">,</span> <span class="s2">&quot;rscc_d_min_b&quot;</span><span class="p">]</span>
  <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">maptbx</span>
  <span class="kn">from</span> <span class="nn">cctbx</span> <span class="kn">import</span> <span class="n">miller</span>
  <span class="kn">import</span> <span class="nn">mmtbx.utils</span>

  <span class="n">mmm</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span><span class="o">.</span><span class="n">min_max_mean</span><span class="p">()</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span>
  <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span><span class="o">-</span><span class="n">mmm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span><span class="o">/</span><span class="nb">map</span><span class="o">.</span><span class="n">sample_standard_deviation</span><span class="p">()</span>
  <span class="n">cg</span> <span class="o">=</span> <span class="n">maptbx</span><span class="o">.</span><span class="n">crystal_gridding</span><span class="p">(</span>
    <span class="n">unit_cell</span>             <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">(),</span>
    <span class="n">space_group_info</span>      <span class="o">=</span> <span class="n">crystal_symmetry</span><span class="o">.</span><span class="n">space_group_info</span><span class="p">(),</span>
    <span class="n">pre_determined_n_real</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">accessor</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
  <span class="c1">#</span>
  <span class="n">ph_dc</span> <span class="o">=</span> <span class="n">pdb_hierarchy</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
  <span class="n">xrs</span> <span class="o">=</span> <span class="n">pdb_hierarchy</span><span class="o">.</span><span class="n">extract_xray_structure</span><span class="p">(</span><span class="n">crystal_symmetry</span><span class="o">=</span><span class="n">crystal_symmetry</span><span class="p">)</span>
  <span class="n">mmtbx</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">setup_scattering_dictionaries</span><span class="p">(</span>
    <span class="n">scattering_table</span> <span class="o">=</span> <span class="s2">&quot;electron&quot;</span><span class="p">,</span>
    <span class="n">xray_structure</span>   <span class="o">=</span> <span class="n">xrs</span><span class="p">,</span>
    <span class="n">d_min</span>            <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="c1">#</span>
  <span class="n">bs</span> <span class="o">=</span> <span class="n">pdb_hierarchy</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span><span class="o">.</span><span class="n">extract_b</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;rscc_d_min_b&quot;</span><span class="p">:</span>
    <span class="n">occs</span> <span class="o">=</span> <span class="n">pdb_hierarchy</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span><span class="o">.</span><span class="n">extract_occ</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">occs</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">results_b</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
  <span class="n">chunk_selections</span> <span class="o">=</span> <span class="n">pdb_hierarchy</span><span class="o">.</span><span class="n">chunk_selections</span><span class="p">(</span>
    <span class="n">residues_per_chunk</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
  <span class="c1">#</span>
  <span class="k">for</span> <span class="n">chunk_sel</span> <span class="ow">in</span> <span class="n">chunk_selections</span><span class="p">:</span>
    <span class="n">ph_sel</span>  <span class="o">=</span> <span class="n">pdb_hierarchy</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">chunk_sel</span><span class="p">)</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
    <span class="n">xrs_sel</span> <span class="o">=</span> <span class="n">xrs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">chunk_sel</span><span class="p">)</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">mmtbx</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">extract_box_around_model_and_map</span><span class="p">(</span>
      <span class="n">xray_structure</span>   <span class="o">=</span> <span class="n">xrs_sel</span><span class="p">,</span>
      <span class="n">map_data</span>         <span class="o">=</span> <span class="nb">map</span><span class="p">,</span>
      <span class="n">box_cushion</span>      <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
      <span class="n">soft_mask</span>        <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
      <span class="n">soft_mask_radius</span> <span class="o">=</span> <span class="n">soft_mask_radius</span><span class="p">,</span>
      <span class="n">mask_atoms</span>       <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1">#####</span>
    <span class="n">fo</span> <span class="o">=</span> <span class="n">miller</span><span class="o">.</span><span class="n">structure_factor_box_from_map</span><span class="p">(</span>
      <span class="n">crystal_symmetry</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">xray_structure_box</span><span class="o">.</span><span class="n">crystal_symmetry</span><span class="p">(),</span>
      <span class="nb">map</span>              <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">map_box</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;rscc_d_min_b&quot;</span><span class="p">:</span>
      <span class="n">fo</span><span class="o">=</span><span class="n">fo</span><span class="o">.</span><span class="n">resolution_filter</span><span class="p">(</span><span class="n">d_min</span><span class="o">=</span><span class="n">hard_d_min</span><span class="p">)</span>
      <span class="n">box</span><span class="o">.</span><span class="n">xray_structure_box</span><span class="o">.</span><span class="n">set_b_iso</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">structure_factors_from_scatterers</span><span class="p">(</span>
      <span class="n">xray_structure</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">xray_structure_box</span><span class="p">)</span><span class="o">.</span><span class="n">f_calc</span><span class="p">()</span>
    <span class="n">b_iso</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">d_min</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cc</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;fsc&quot;</span><span class="p">):</span>
      <span class="n">d_min</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">d_min_from_fsc</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">fo</span><span class="p">,</span> <span class="n">bin_width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">fsc_cutoff</span><span class="o">=</span><span class="n">fsc_cutoff</span><span class="p">)</span><span class="o">.</span><span class="n">d_min</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;rscc&quot;</span><span class="p">):</span>
      <span class="n">d_spacings</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
      <span class="n">ss</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">d_spacings</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span>
      <span class="n">d_min</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">maptbx</span><span class="o">.</span><span class="n">cc_complex_complex</span><span class="p">(</span>
        <span class="n">f_1</span>        <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span>
        <span class="n">f_2</span>        <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span>
        <span class="n">d_spacings</span> <span class="o">=</span> <span class="n">d_spacings</span><span class="p">,</span>
        <span class="n">ss</span>         <span class="o">=</span> <span class="n">ss</span><span class="p">,</span>
        <span class="n">d_mins</span>     <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="n">i</span><span class="o">/</span><span class="mf">10.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">100</span><span class="p">)]),</span>
        <span class="n">b_iso</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;rscc_d_min_b&quot;</span><span class="p">):</span>
      <span class="n">d_spacings</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">d_spacings</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
      <span class="n">ss</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">d_spacings</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span>
      <span class="n">d_min_best</span><span class="o">=</span><span class="kc">None</span>
      <span class="n">cc_best</span><span class="o">=</span><span class="kc">None</span>
      <span class="n">b_best</span><span class="o">=</span><span class="kc">None</span>
      <span class="n">scale</span><span class="o">=</span><span class="mi">20</span>
      <span class="n">low_value</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">b_range_low</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span>
      <span class="n">high_value</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">low_value</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">b_range_high</span><span class="o">/</span><span class="n">scale</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">b_iso</span> <span class="ow">in</span>  <span class="p">[</span> <span class="n">i</span><span class="o">*</span><span class="n">scale</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">low_value</span><span class="p">,</span><span class="n">high_value</span><span class="p">)]:</span>
        <span class="n">d_min</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">maptbx</span><span class="o">.</span><span class="n">cc_complex_complex</span><span class="p">(</span>
        <span class="n">f_1</span>        <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="c1"># note swapped from rscc f_1 is fixed</span>
        <span class="n">f_2</span>        <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span>
        <span class="n">d_spacings</span> <span class="o">=</span> <span class="n">d_spacings</span><span class="p">,</span>
        <span class="n">ss</span>         <span class="o">=</span> <span class="n">ss</span><span class="p">,</span>
        <span class="n">d_mins</span>     <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="n">i</span><span class="o">/</span><span class="mf">10.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hard_d_min</span><span class="o">*</span><span class="mi">10</span><span class="p">),</span><span class="mi">100</span><span class="p">)]),</span>
        <span class="n">b_iso</span>      <span class="o">=</span> <span class="n">b_iso</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cc_best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cc</span><span class="o">&gt;</span><span class="n">cc_best</span><span class="p">:</span>
          <span class="n">cc_best</span><span class="o">=</span><span class="n">cc</span>
          <span class="n">d_min_best</span><span class="o">=</span><span class="n">d_min</span>
          <span class="n">b_best</span><span class="o">=</span><span class="n">b_iso</span>
      <span class="n">cc</span><span class="o">=</span><span class="n">cc_best</span>
      <span class="n">d_min</span><span class="o">=</span><span class="n">d_min_best</span>
      <span class="n">b_iso</span><span class="o">=</span><span class="n">b_best</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CHUNK d_min </span><span class="si">%s</span><span class="s2"> b </span><span class="si">%s</span><span class="s2"> cc </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">d_min</span><span class="p">,</span><span class="n">b_iso</span><span class="p">,</span><span class="n">cc</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_min</span><span class="p">)</span>
    <span class="n">results_b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_iso</span><span class="p">)</span>

    <span class="n">ph_sel</span><span class="o">.</span><span class="n">adopt_xray_structure</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">xray_structure_box</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;rscc_d_min_b&quot;</span><span class="p">):</span>
      <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">chunk_sel</span><span class="p">,</span> <span class="n">b_iso</span><span class="p">)</span>  <span class="c1"># b value in B</span>
      <span class="n">occs</span> <span class="o">=</span> <span class="n">occs</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">chunk_sel</span><span class="p">,</span> <span class="n">d_min</span><span class="p">)</span> <span class="c1"># d_min in occ</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">chunk_sel</span><span class="p">,</span> <span class="n">d_min</span><span class="p">)</span>  <span class="c1"># d_min in B value</span>

  <span class="nb">print</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span> <span class="n">flex</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span> <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
  <span class="n">pdb_hierarchy</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span><span class="o">.</span><span class="n">set_b</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;rscc_d_min_b&quot;</span><span class="p">):</span>
     <span class="n">pdb_hierarchy</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span><span class="o">.</span><span class="n">set_occ</span><span class="p">(</span><span class="n">occs</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">pdb_hierarchy</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="https://dials.github.io/images/logos/ukri-stfc.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="https://dials.github.io/images/logos/lbl.png" /></a>
  <a href="http://smb.slac.stanford.edu/"><img class="logofooter" alt="SSRL/SMB" src="https://dials.github.io/images/logos/smbssrl.jpg" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &copy;2020, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>