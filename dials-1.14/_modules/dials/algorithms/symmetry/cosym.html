


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>dials.algorithms.symmetry.cosym &#8212; DIALS  documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/dials-styles.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="logoheader container">
  <a href="../../../../index.html">
  <img class="logoheader" alt="DIALS" src="../../../../_static/dials_header.png" />
  </a>
  </div>
  

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            <a class="old-documentation" href="../../../../index.html/../../_modules/dials/algorithms/symmetry/cosym.html">
    This documentation page refers to a previous release of DIALS (1.14).<br/>
    Click here to go to the corresponding page for the latest version of DIALS
  </a>
  <h1>Source code for dials.algorithms.symmetry.cosym</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Methods for symmetry determination from partial datasets.</span>

<span class="sd">This module implements the methods of `Gildea, R. J. &amp; Winter, G. (2018).</span>
<span class="sd">Acta Cryst. D74, 405-410 &lt;https://doi.org/10.1107/S2059798318002978&gt;`_ for</span>
<span class="sd">determination of Patterson group symmetry from sparse multi-crystal data sets in</span>
<span class="sd">the presence of an indexing ambiguity.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">libtbx</span> <span class="k">import</span> <span class="n">Auto</span>
<span class="kn">from</span> <span class="nn">libtbx</span> <span class="k">import</span> <span class="n">table_utils</span>
<span class="kn">from</span> <span class="nn">scitbx.array_family</span> <span class="k">import</span> <span class="n">flex</span>
<span class="kn">from</span> <span class="nn">cctbx</span> <span class="k">import</span> <span class="n">sgtbx</span>
<span class="kn">import</span> <span class="nn">iotbx.phil</span>

<span class="kn">from</span> <span class="nn">dials.algorithms.symmetry.cosym</span> <span class="k">import</span> <span class="n">target</span>
<span class="kn">from</span> <span class="nn">dials.algorithms.symmetry.cosym</span> <span class="k">import</span> <span class="n">engine</span>
<span class="kn">from</span> <span class="nn">dials.algorithms.symmetry</span> <span class="k">import</span> <span class="n">symmetry_base</span>

<span class="n">phil_scope</span> <span class="o">=</span> <span class="n">iotbx</span><span class="o">.</span><span class="n">phil</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;\</span>

<span class="sd">normalisation = kernel quasi *ml_iso ml_aniso</span>
<span class="sd">  .type = choice</span>

<span class="sd">d_min = Auto</span>
<span class="sd">  .type = float(value_min=0)</span>

<span class="sd">min_i_mean_over_sigma_mean = 4</span>
<span class="sd">  .type = float(value_min=0)</span>

<span class="sd">min_cc_half = 0.6</span>
<span class="sd">  .type = float(value_min=0, value_max=1)</span>

<span class="sd">lattice_group = None</span>
<span class="sd">  .type = space_group</span>

<span class="sd">dimensions = None</span>
<span class="sd">  .type = int(value_min=2)</span>

<span class="sd">use_curvatures = True</span>
<span class="sd">  .type = bool</span>

<span class="sd">weights = count standard_error</span>
<span class="sd">  .type = choice</span>

<span class="sd">min_pairs = 3</span>
<span class="sd">  .type = int(value_min=1)</span>
<span class="sd">  .help = &#39;Minimum number of pairs for inclusion of correlation coefficient in calculation of Rij matrix.&#39;</span>

<span class="sd">save_plot = True</span>
<span class="sd">  .type = bool</span>

<span class="sd">plot_prefix = &#39;&#39;</span>
<span class="sd">  .type = str</span>

<span class="sd">termination_params {</span>
<span class="sd">  max_iterations = 100</span>
<span class="sd">    .type = int(value_min=0)</span>
<span class="sd">  max_calls = None</span>
<span class="sd">    .type = int(value_min=0)</span>
<span class="sd">  traditional_convergence_test = True</span>
<span class="sd">    .type = bool</span>
<span class="sd">  traditional_convergence_test_eps = 1</span>
<span class="sd">    .type = float</span>
<span class="sd">  drop_convergence_test_n_test_points=5</span>
<span class="sd">    .type = int(value_min=2)</span>
<span class="sd">  drop_convergence_test_max_drop_eps=1.e-5</span>
<span class="sd">    .type = float(value_min=0)</span>
<span class="sd">  drop_convergence_test_iteration_coefficient=2</span>
<span class="sd">    .type = float(value_min=1)</span>
<span class="sd">}</span>

<span class="sd">cluster {</span>
<span class="sd">  method = dbscan bisect minimize_divide agglomerative *seed</span>
<span class="sd">    .type = choice</span>
<span class="sd">  dbscan {</span>
<span class="sd">    eps = 0.5</span>
<span class="sd">      .type = float(value_min=0)</span>
<span class="sd">    min_samples = 5</span>
<span class="sd">      .type = int(value_min=1)</span>
<span class="sd">  }</span>
<span class="sd">  bisect {</span>
<span class="sd">    axis = 0</span>
<span class="sd">      .type = int(value_min=0)</span>
<span class="sd">  }</span>
<span class="sd">  agglomerative {</span>
<span class="sd">    n_clusters = 2</span>
<span class="sd">      .type = int(value_min=1)</span>
<span class="sd">  }</span>
<span class="sd">  seed {</span>
<span class="sd">    min_silhouette_score = 0.2</span>
<span class="sd">      .type = float(value_min=-1, value_max=1)</span>
<span class="sd">    n_clusters = auto</span>
<span class="sd">      .type = int(value_min=1)</span>
<span class="sd">  }</span>
<span class="sd">}</span>

<span class="sd">nproc = 1</span>
<span class="sd">  .type = int(value_min=1)</span>
<span class="sd">  .help = &quot;The number of processes to use.&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="analyse_datasets"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.cosym.analyse_datasets">[docs]</a><span class="k">class</span> <span class="nc">analyse_datasets</span><span class="p">(</span><span class="n">symmetry_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Peform cosym analysis.</span>

<span class="sd">    Peform cosym analysis on the input intensities using the methods of</span>
<span class="sd">    `Gildea, R. J. &amp; Winter, G. (2018). Acta Cryst. D74, 405-410</span>
<span class="sd">    &lt;https://doi.org/10.1107/S2059798318002978&gt;`_ for</span>
<span class="sd">    determination of Patterson group symmetry from sparse multi-crystal data sets in</span>
<span class="sd">    the presence of an indexing ambiguity.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise an analyse_datasets object.</span>

<span class="sd">        Args:</span>
<span class="sd">          intensities (cctbx.miller.array): The intensities on which to perform</span>
<span class="sd">            cosym anaylsis.</span>
<span class="sd">          params (libtbx.phil.scope_extract): Parameters for the analysis.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_space_group</span> <span class="o">=</span> <span class="n">intensities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">space_group</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">analyse_datasets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">intensities</span><span class="p">,</span>
            <span class="n">normalisation</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">normalisation</span><span class="p">,</span>
            <span class="n">lattice_symmetry_max_delta</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
            <span class="n">d_min</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">d_min</span><span class="p">,</span>
            <span class="n">min_i_mean_over_sigma_mean</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">min_i_mean_over_sigma_mean</span><span class="p">,</span>
            <span class="n">min_cc_half</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">min_cc_half</span><span class="p">,</span>
            <span class="n">relative_length_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">absolute_angle_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="o">.</span><span class="n">customized_copy</span><span class="p">(</span>
            <span class="n">space_group_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_space_group</span><span class="o">.</span><span class="n">change_basis</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cb_op_inp_min</span>
            <span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">is</span> <span class="n">Auto</span><span class="p">:</span>
            <span class="n">dimensions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="n">lattice_group</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lattice_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lattice_group</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">lattice_group</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="o">.</span><span class="n">build_derived_patterson_group</span><span class="p">()</span>
                <span class="o">.</span><span class="n">info</span><span class="p">()</span>
                <span class="o">.</span><span class="n">primitive_setting</span><span class="p">()</span>
                <span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset_ids</span><span class="p">,</span>
            <span class="n">min_pairs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">min_pairs</span><span class="p">,</span>
            <span class="n">lattice_group</span><span class="o">=</span><span class="n">lattice_group</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
            <span class="n">nproc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">nproc</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">is</span> <span class="n">Auto</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">is</span> <span class="n">Auto</span><span class="p">:</span>
            <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">functional</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">explained_variance</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">explained_variance_ratio</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_optimise</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Functional: </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_principal_component_analysis</span><span class="p">()</span>
                <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
                <span class="n">functional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>
                <span class="n">explained_variance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_variance</span><span class="p">)</span>
                <span class="n">explained_variance_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explained_variance_ratio</span><span class="p">)</span>

            <span class="c1"># Find the elbow point of the curve, in the same manner as that used by</span>
            <span class="c1"># distl spotfinder for resolution method 1 (Zhang et al 2006).</span>
            <span class="c1"># See also dials/algorithms/spot_finding/per_image_analysis.py</span>

            <span class="kn">from</span> <span class="nn">scitbx</span> <span class="k">import</span> <span class="n">matrix</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">functional</span><span class="p">)</span>
            <span class="n">slopes</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">p_m</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">min_index</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>

            <span class="n">x1</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">p_m</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">p_m</span><span class="p">]))</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">gaps</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">(((</span><span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="o">-</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p_m</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">col</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span>
                <span class="n">g</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
                <span class="n">gaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

            <span class="n">p_k</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">max_index</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span>
            <span class="n">g_k</span> <span class="o">=</span> <span class="n">gaps</span><span class="p">[</span><span class="n">p_k</span><span class="p">]</span>
            <span class="n">p_g</span> <span class="o">=</span> <span class="n">p_k</span>

            <span class="n">x_g</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">p_g</span> <span class="o">+</span> <span class="n">p_m</span><span class="p">]</span>
            <span class="n">y_g</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">p_g</span> <span class="o">+</span> <span class="n">p_m</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Best number of dimensions: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">x_g</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">set_dimensions</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x_g</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">save_plot</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">functional</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_g</span><span class="p">,</span> <span class="n">x_g</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">())</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Functional&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">functional_vs_dimension.png&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">expl_var</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">explained_variance</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">expl_var</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dim</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_g</span><span class="p">,</span> <span class="n">x_g</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">())</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Dimension&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Explained variance&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">explained_variance_vs_dimension.png&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span>
                <span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">expl_var_ratio</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">explained_variance_ratio</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">expl_var_ratio</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dim</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_g</span><span class="p">,</span> <span class="n">x_g</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">())</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Dimension&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Explained variance ratio&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">explained_variance_ratio_vs_dimension.png&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span>
                <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_optimise</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_principal_component_analysis</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cosine_analysis</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_analysis</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">NN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dim</span>
        <span class="n">n_sym_ops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">get_sym_ops</span><span class="p">())</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">random_double</span><span class="p">(</span><span class="n">NN</span> <span class="o">*</span> <span class="n">n_sym_ops</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">scitbx.lbfgs</span>

        <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">termination_params</span>
        <span class="n">termination_params</span> <span class="o">=</span> <span class="n">scitbx</span><span class="o">.</span><span class="n">lbfgs</span><span class="o">.</span><span class="n">termination_parameters</span><span class="p">(</span>
            <span class="n">traditional_convergence_test</span><span class="o">=</span><span class="n">tp</span><span class="o">.</span><span class="n">traditional_convergence_test</span><span class="p">,</span>
            <span class="n">traditional_convergence_test_eps</span><span class="o">=</span><span class="n">tp</span><span class="o">.</span><span class="n">traditional_convergence_test_eps</span><span class="p">,</span>
            <span class="n">drop_convergence_test_n_test_points</span><span class="o">=</span><span class="n">tp</span><span class="o">.</span><span class="n">drop_convergence_test_n_test_points</span><span class="p">,</span>
            <span class="n">drop_convergence_test_max_drop_eps</span><span class="o">=</span><span class="n">tp</span><span class="o">.</span><span class="n">drop_convergence_test_max_drop_eps</span><span class="p">,</span>
            <span class="n">drop_convergence_test_iteration_coefficient</span><span class="o">=</span><span class="n">tp</span><span class="o">.</span><span class="n">drop_convergence_test_iteration_coefficient</span><span class="p">,</span>
            <span class="c1"># min_iterations=tp.min_iterations,</span>
            <span class="n">max_iterations</span><span class="o">=</span><span class="n">tp</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
            <span class="n">max_calls</span><span class="o">=</span><span class="n">tp</span><span class="o">.</span><span class="n">max_calls</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">lbfgs_with_curvs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="n">coords</span><span class="p">,</span>
            <span class="n">use_curvatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">use_curvatures</span><span class="p">,</span>
            <span class="n">termination_params</span><span class="o">=</span><span class="n">termination_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span> <span class="o">=</span> <span class="n">M</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">()</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">NN</span> <span class="o">*</span> <span class="n">n_sym_ops</span><span class="p">))</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">matrix_transpose_in_place</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="k">def</span> <span class="nf">_principal_component_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Perform PCA</span>
        <span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="k">import</span> <span class="n">PCA</span>

        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">as_numpy_array</span><span class="p">()</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Principal component analysis:&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Explained variance: &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%.2g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Explained variance ratio: &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%.2g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explained_variance</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explained_variance_ratio</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">pca</span><span class="o">.</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">x_reduced</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">numpy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">x_reduced</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_cosine_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.cluster</span> <span class="k">import</span> <span class="n">hierarchy</span>
        <span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="k">as</span> <span class="nn">ssd</span>

        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">as_numpy_array</span><span class="p">()</span>
        <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">ssd</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>
        <span class="n">cos_angle</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ssd</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">)</span>
        <span class="n">linkage_matrix</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">linkage</span><span class="p">(</span><span class="n">dist_mat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">)</span>

        <span class="n">c</span><span class="p">,</span> <span class="n">coph_dists</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">cophenet</span><span class="p">(</span><span class="n">linkage_matrix</span><span class="p">,</span> <span class="n">dist_mat</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Cophenetic correlation coefficient between heirarchical clustering and pairwise distance matrix: </span><span class="si">%.3f</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="n">c</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_plot</span><span class="p">:</span>
            <span class="n">plot_matrix</span><span class="p">(</span>
                <span class="n">cos_angle</span><span class="p">,</span>
                <span class="n">linkage_matrix</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">cos_angle_matrix.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plot_dendrogram</span><span class="p">(</span>
                <span class="n">linkage_matrix</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">cos_angle_dendrogram.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span>
            <span class="p">)</span>

        <span class="n">sym_ops</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">sgtbx</span><span class="o">.</span><span class="n">rt_mx</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">new_denominators</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">get_sym_ops</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">sym_ops_cos_angle</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">dataset_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)):</span>
            <span class="n">ref_sym_op_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ref_cluster_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">sym_op_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sym_ops</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">ref_sym_op_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ref_sym_op_id</span> <span class="o">=</span> <span class="n">sym_op_id</span>
                    <span class="k">continue</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">sym_ops</span><span class="p">[</span><span class="n">ref_sym_op_id</span><span class="p">]</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sym_ops</span><span class="p">[</span><span class="n">sym_op_id</span><span class="p">])</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">new_denominators</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>

                <span class="n">ref_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)</span> <span class="o">*</span> <span class="n">ref_sym_op_id</span> <span class="o">+</span> <span class="n">dataset_id</span>
                <span class="n">comp_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)</span> <span class="o">*</span> <span class="n">sym_op_id</span> <span class="o">+</span> <span class="n">dataset_id</span>
                <span class="n">sym_ops_cos_angle</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">())</span>
                <span class="n">sym_ops_cos_angle</span><span class="p">[</span><span class="n">op</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">[</span><span class="n">ref_idx</span><span class="p">,</span> <span class="n">comp_idx</span><span class="p">])</span>

        <span class="c1"># print symops sorted by average cos(angle)</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_space_group</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;symop&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;sg&quot;</span><span class="p">,</span> <span class="s2">&quot;mean(cos(angle))&quot;</span><span class="p">,</span> <span class="s2">&quot;median(cos(angle))&quot;</span><span class="p">]]</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sort_permutation</span><span class="p">(</span>
            <span class="n">flex</span><span class="o">.</span><span class="n">double</span><span class="p">([</span><span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span> <span class="k">for</span> <span class="n">ca</span> <span class="ow">in</span> <span class="n">sym_ops_cos_angle</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perm</span><span class="p">:</span>
            <span class="n">op</span><span class="p">,</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">sym_ops_cos_angle</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">sg</span><span class="o">.</span><span class="n">expand_smx</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">order</span><span class="p">()),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">sg</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">reference_setting</span><span class="p">()),</span>
                    <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ca</span><span class="p">),</span>
                    <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">flex</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ca</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Analysis of cos(angle) between points corresponding to the same datasets:&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">table_utils</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">has_header</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_space_group_for_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">sym_ops</span><span class="p">):</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_space_group</span><span class="p">)</span>
        <span class="n">ref_sym_op_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ref_cluster_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">sym_op_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sym_ops</span><span class="p">)):</span>
            <span class="n">i_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span><span class="p">[</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)</span> <span class="o">*</span> <span class="n">sym_op_id</span> <span class="o">+</span> <span class="n">dataset_id</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">i_cluster</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">ref_sym_op_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ref_sym_op_id</span> <span class="o">=</span> <span class="n">sym_op_id</span>
                <span class="n">ref_cluster_id</span> <span class="o">=</span> <span class="n">i_cluster</span>
                <span class="k">continue</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">sym_ops</span><span class="p">[</span><span class="n">ref_sym_op_id</span><span class="p">]</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sym_ops</span><span class="p">[</span><span class="n">sym_op_id</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i_cluster</span> <span class="o">==</span> <span class="n">ref_cluster_id</span><span class="p">:</span>
                <span class="n">sg</span><span class="o">.</span><span class="n">expand_smx</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">new_denominators</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sg</span><span class="o">.</span><span class="n">make_tidy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reindexing_ops_for_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">sym_ops</span><span class="p">,</span> <span class="n">cosets</span><span class="p">):</span>
        <span class="n">reindexing_ops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Number of clusters in labels, ignoring noise if present.</span>
        <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i_cluster</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
            <span class="n">isel</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">i_cluster</span><span class="p">)</span><span class="o">.</span><span class="n">iselection</span><span class="p">()</span>
            <span class="n">dataset_ids</span> <span class="o">=</span> <span class="n">isel</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">first_index</span><span class="p">(</span><span class="n">dataset_ids</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_ids</span> <span class="o">==</span> <span class="n">dataset_id</span><span class="p">)</span><span class="o">.</span><span class="n">iselection</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sym_op_id</span> <span class="o">=</span> <span class="n">isel</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                <span class="n">sym_op_id</span> <span class="o">=</span> <span class="n">isel</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">partition</span> <span class="ow">in</span> <span class="n">cosets</span><span class="o">.</span><span class="n">partitions</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sym_ops</span><span class="p">[</span><span class="n">sym_op_id</span><span class="p">]</span> <span class="ow">in</span> <span class="n">partition</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i_cluster</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reindexing_ops</span><span class="p">:</span>
                            <span class="n">reindexing_ops</span><span class="p">[</span><span class="n">i_cluster</span><span class="p">]</span> <span class="o">=</span> <span class="n">partition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_xyz</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">reindexing_ops</span>

    <span class="k">def</span> <span class="nf">_cluster_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_clustering</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>

        <span class="n">cluster_miller_arrays</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">space_groups</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">sym_ops</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">sgtbx</span><span class="o">.</span><span class="n">rt_mx</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">new_denominators</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">get_sym_ops</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space_groups</span> <span class="o">=</span> <span class="n">space_groups</span>

        <span class="n">reindexing_ops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">space_groups</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">dataset_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">)):</span>
            <span class="n">space_groups</span><span class="p">[</span><span class="n">dataset_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space_group_for_dataset</span><span class="p">(</span>
                <span class="n">dataset_id</span><span class="p">,</span> <span class="n">sym_ops</span>
            <span class="p">)</span>

            <span class="n">cosets</span> <span class="o">=</span> <span class="n">sgtbx</span><span class="o">.</span><span class="n">cosets</span><span class="o">.</span><span class="n">left_decomposition</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">_lattice_group</span><span class="p">,</span>
                <span class="n">space_groups</span><span class="p">[</span><span class="n">dataset_id</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">primitive_setting</span><span class="p">()</span><span class="o">.</span><span class="n">group</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="n">reindexing_ops</span><span class="p">[</span><span class="n">dataset_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reindexing_ops_for_dataset</span><span class="p">(</span>
                <span class="n">dataset_id</span><span class="p">,</span> <span class="n">sym_ops</span><span class="p">,</span> <span class="n">cosets</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">space_groups</span> <span class="o">=</span> <span class="n">space_groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reindexing_ops</span> <span class="o">=</span> <span class="n">reindexing_ops</span>

    <span class="k">def</span> <span class="nf">_do_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;dbscan&quot;</span><span class="p">:</span>
            <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbscan_clustering</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;bisect&quot;</span><span class="p">:</span>
            <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bisect_clustering</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;minimize_divide&quot;</span><span class="p">:</span>
            <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimize_divide_clustering</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;agglomerative&quot;</span><span class="p">:</span>
            <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agglomerative_clustering</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;seed&quot;</span><span class="p">:</span>
            <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seed_clustering</span>
        <span class="k">return</span> <span class="n">clustering</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_dbscan_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">StandardScaler</span>

        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="o">.</span><span class="n">as_numpy_array</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Perform cluster analysis</span>
        <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">DBSCAN</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span>
            <span class="n">eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">dbscan</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span>
            <span class="n">min_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">dbscan</span><span class="o">.</span><span class="n">min_samples</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="k">return</span> <span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">labels_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_bisect_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">bisect</span><span class="o">.</span><span class="n">axis</span>
        <span class="k">assert</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="p">[:,</span> <span class="n">axis</span> <span class="p">:</span> <span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cluster_labels</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_labels</span>

    <span class="k">def</span> <span class="nf">_minimize_divide_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">cctbx.merging.brehm_diederichs</span> <span class="k">import</span> <span class="n">minimize_divide</span>

        <span class="n">selection</span> <span class="o">=</span> <span class="n">minimize_divide</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">plus_minus</span><span class="p">()</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cluster_labels</span><span class="o">.</span><span class="n">set_selected</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_labels</span>

    <span class="k">def</span> <span class="nf">_agglomerative_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">as_numpy_array</span><span class="p">()</span>

        <span class="c1"># Perform cluster analysis</span>
        <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">AgglomerativeClustering</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span>
            <span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">agglomerative</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span>
            <span class="n">linkage</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span>
            <span class="n">affinity</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">labels_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_seed_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dials.algorithms.symmetry.cosym.seed_clustering</span> <span class="k">import</span> <span class="n">seed_clustering</span>

        <span class="n">clustering</span> <span class="o">=</span> <span class="n">seed_clustering</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_intensities</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">get_sym_ops</span><span class="p">()),</span>
            <span class="n">min_silhouette_score</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">min_silhouette_score</span><span class="p">,</span>
            <span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span>
            <span class="n">plot_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save_plot</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">clustering</span><span class="o">.</span><span class="n">cluster_labels</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">plot_rij_matrix</span><span class="p">(</span><span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">rij.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">plot_rij_histogram</span><span class="p">(</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">rij_hist.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">plot_rij_cumulative_frequency</span><span class="p">(</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">rij_sorted.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">plot_wij_matrix</span><span class="p">(</span><span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">wij.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">plot_wij_histogram</span><span class="p">(</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">wij_hist.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">plot_wij_cumulative_frequency</span><span class="p">(</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">wij_sorted.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span>
        <span class="p">)</span>

        <span class="n">coord_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
        <span class="n">coord_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">coord_x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">coord_y</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="p">(</span><span class="n">coord_x</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">coord_y</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="n">coord_reduced_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
        <span class="n">coord_reduced_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
        <span class="n">_plot</span><span class="p">(</span>
            <span class="p">(</span><span class="n">coord_x</span><span class="p">,</span> <span class="n">coord_y</span><span class="p">),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span><span class="p">,</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">xy.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_plot</span><span class="p">(</span>
            <span class="p">(</span><span class="n">coord_reduced_x</span><span class="p">,</span> <span class="n">coord_reduced_y</span><span class="p">),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span><span class="p">,</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">xy_pca.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_plot_angles</span><span class="p">(</span>
            <span class="p">(</span><span class="n">coord_x</span><span class="p">,</span> <span class="n">coord_y</span><span class="p">),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span><span class="p">,</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">phi_r.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_plot_angles</span><span class="p">(</span>
            <span class="p">(</span><span class="n">coord_reduced_x</span><span class="p">,</span> <span class="n">coord_reduced_y</span><span class="p">),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span><span class="p">,</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">phi_r_pca.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">coord_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
            <span class="n">coord_reduced_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_reduced</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">as_1d</span><span class="p">()</span>
            <span class="n">_plot</span><span class="p">(</span>
                <span class="p">(</span><span class="n">coord_x</span><span class="p">,</span> <span class="n">coord_y</span><span class="p">,</span> <span class="n">coord_z</span><span class="p">),</span>
                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span><span class="p">,</span>
                <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">xyz.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_plot</span><span class="p">(</span>
                <span class="p">(</span><span class="n">coord_reduced_x</span><span class="p">,</span> <span class="n">coord_reduced_y</span><span class="p">,</span> <span class="n">coord_reduced_z</span><span class="p">),</span>
                <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_labels</span><span class="p">,</span>
                <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">xyz_pca.png&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">plot_prefix</span><span class="p">,</span>
            <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;xy.png&quot;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span>

    <span class="n">coord_x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coord_y</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="k">import</span> <span class="n">Axes3D</span>  <span class="c1"># import dependency</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
        <span class="n">coord_z</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">coord_z</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_x</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span>
    <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">unique_labels</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">colours</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)))</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
        <span class="n">colours</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">,</span> <span class="n">colours</span><span class="p">):</span>
        <span class="n">isel</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">iselection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># or len(class_members) &lt; min_cluster_size:</span>
            <span class="c1"># Black used for noise.</span>
            <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span>
            <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;0.25&quot;</span>  <span class="c1"># mid-grey</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">col</span>
        <span class="k">if</span> <span class="n">coord_z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">coord_x</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span>
                <span class="n">coord_y</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span>
                <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># plot cluster centroid</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coord_x</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">)),</span>
                    <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coord_y</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">)),</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">markersize</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">coord_x</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span>
                <span class="n">coord_y</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span>
                <span class="n">coord_z</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span>
                <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># plot cluster centroid</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coord_x</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">)),</span>
                    <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coord_y</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">)),</span>
                    <span class="n">flex</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coord_z</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">)),</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">markersize</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_name</span><span class="p">,</span> <span class="n">size_inches</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_plot_angles</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;phi_r.png&quot;</span><span class="p">):</span>
    <span class="n">coord_x</span><span class="p">,</span> <span class="n">coord_y</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">coord_x</span><span class="p">)</span> <span class="o">+</span> <span class="n">flex</span><span class="o">.</span><span class="n">pow2</span><span class="p">(</span><span class="n">coord_y</span><span class="p">))</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">coord_y</span><span class="p">,</span> <span class="n">coord_x</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">math</span>

    <span class="n">phi_deg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">flex</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord_x</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span>
    <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">unique_labels</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">colours</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)))</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
        <span class="n">colours</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">,</span> <span class="n">colours</span><span class="p">):</span>
        <span class="n">isel</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">iselection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># or len(class_members) &lt; min_cluster_size:</span>
            <span class="c1"># Black used for noise.</span>
            <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span>
            <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;0.25&quot;</span>  <span class="c1"># mid-grey</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># darken the edges</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="mf">0.75</span>
            <span class="n">edgecolor</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">col</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">phi_deg</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span>
            <span class="n">r</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span>
            <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Angle ($^{\circ}$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_name</span><span class="p">,</span> <span class="n">size_inches</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>


<div class="viewcode-block" id="plot_matrix"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.cosym.plot_matrix">[docs]</a><span class="k">def</span> <span class="nf">plot_matrix</span><span class="p">(</span>
    <span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">linkage_matrix</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_threshold</span><span class="o">=</span><span class="mf">0.05</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot correlation and linkage matrices.</span>

<span class="sd">    Args:</span>
<span class="sd">      correlation_matrix (numpy.ndarray): The distance matrix used to generate</span>
<span class="sd">        the ``linkage_matrix``.</span>
<span class="sd">      linkage_matrix (numpy.ndarray): The hierarchical clustering of centroids of</span>
<span class="sd">        the initial clustering as produced by</span>
<span class="sd">        :func:`scipy.cluster.hierarchy.linkage`.</span>
<span class="sd">      file_name (str): The output file name.</span>
<span class="sd">      labels (list): Optional labels for the leaves of the dendrogram.</span>
<span class="sd">      color_threshold (float): The color threshold passed to the</span>
<span class="sd">        :func:scipy.cluster.hierarchy.dendrogram` function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">correlation_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
    <span class="kn">from</span> <span class="nn">scipy.cluster</span> <span class="k">import</span> <span class="n">hierarchy</span>

    <span class="c1"># Compute and plot dendrogram.</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
    <span class="n">axdendro</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">linkage_matrix</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">color_threshold</span><span class="o">=</span><span class="n">color_threshold</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
    <span class="n">axdendro</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axdendro</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="c1"># Plot distance matrix.</span>
    <span class="n">axmatrix</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="s2">&quot;leaves&quot;</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">correlation_matrix</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">axmatrix</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
    <span class="n">axmatrix</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axmatrix</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>
        <span class="n">axmatrix</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))))</span>
        <span class="n">axmatrix</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
        <span class="n">axmatrix</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>

    <span class="c1"># Plot colorbar.</span>
    <span class="n">axcolor</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">axcolor</span><span class="p">)</span>

    <span class="c1"># Display and save figure.</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_dendrogram"><a class="viewcode-back" href="../../../../documentation/library_reference/algorithms/dials.algorithms.symmetry.html#dials.algorithms.symmetry.cosym.plot_dendrogram">[docs]</a><span class="k">def</span> <span class="nf">plot_dendrogram</span><span class="p">(</span><span class="n">linkage_matrix</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot dendrogram from a linkage matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">      linkage_matrix (numpy.ndarray): The hierarchical clustering of centroids of</span>
<span class="sd">        the initial clustering as produced by</span>
<span class="sd">        :func:`scipy.cluster.hierarchy.linkage`.</span>
<span class="sd">      file_name (str): The output file name.</span>
<span class="sd">      labels (list): Optional labels for the leaves of the dendrogram.</span>
<span class="sd">      color_threshold (float): The color threshold passed to the</span>
<span class="sd">        :func:scipy.cluster.hierarchy.dendrogram` function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="kn">from</span> <span class="nn">scipy.cluster</span> <span class="k">import</span> <span class="n">hierarchy</span>

    <span class="n">ddict</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span>
        <span class="n">linkage_matrix</span><span class="p">,</span>
        <span class="n">color_threshold</span><span class="o">=</span><span class="n">color_threshold</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">show_leaf_counts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">locs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../documentation/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../howto.html">How-to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workshops/index.html">Workshops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../links.html">Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="https://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../../../_static/diamond_logo.png" /></a>
  <a href="https://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../../../_static/CCP4-logo-plain.png" /></a>
  <a href="https://www.lbl.gov/"><img class="logofooter" alt="LBL" src="../../../../_static/LBL-logo-wide.jpeg" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="../../../../_static/STFC_logo.png" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &copy;2019, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>