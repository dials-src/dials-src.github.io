
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Correcting poor initial geometry &mdash; DIALS  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/button.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/dials-styles.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/dials_icon.png"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="top" title="DIALS  documentation" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
  <div class="logoheader container">
  <a href="../../index.html">
  <img class="logoheader" alt="DIALS" src="../../_static/dials_header.png" />
  </a>
  </div>
  


  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="correcting-poor-initial-geometry">
<h1>Correcting poor initial geometry<a class="headerlink" href="#correcting-poor-initial-geometry" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>One of the most common problems faced by users of any data processing program
is incorrect information about the experimental geometry in the input. This
will often cause outright failures in indexing, but sometimes more subtle
effects are possible, such as misindexing. In such cases, it may be possible
to index and refine a lattice that on the face of it looks reasonable but is
actually shifted so that H, K or L (or some combination of these) are off by
some integer value (often +/- 1).</p>
<p>DIALS uses the information written to the image headers to form its initial
model for the experiment geometry. That is, we trust that the beamline has been
set up correctly and the files produced at the beamline are a good
description of the experiment that was performed. Using the
<strong class="program">dxtbx</strong> library within <strong class="program">cctbx</strong> means we even recognise
specific beamlines in many cases, and interpret the files according to
custom format readers that are appropriate for those beamlines.</p>
<p>Unfortunately it is not always possible to be this trusting. Beamlines are
often changing and sometimes the metadata recorded with your diffraction images
are out of date. Sometimes values for things like the beam centre depend on
other factors such as the wavelength and detector distance, and your experiment
might have been performed outside the range that was used during beamline
calibration. Whatever the cause, incorrect image headers are a reality that
we have to be aware of. Some programs go as far as to ignore the image
headers entirely and pass the responsiblity on to the supposed existence of an
accurate &#8216;site file&#8217; describing the experimental set up. Although it may be
easier for a user to edit an incorrect site file rather than broken image
headers, the problem still remains that if the experiment description is
sufficiently wrong, the processing will not be straightforward.</p>
<p>In this tutorial we describe some of the ways in which bad geometry
derived from wrong image headers can be worked around within DIALS, and we
use an example in which the initially incorrect geometry tricks the indexing
program into misindexing, which, if we were being careless, could have lead
to the integration of a useless data set. This tutorial is a cautionary tale,
the moral of which is that the user is still required to read the output of
the programs they run!</p>
</div>
<div class="section" id="tutorial-data">
<h2>Tutorial data<a class="headerlink" href="#tutorial-data" title="Permalink to this headline">¶</a></h2>
<p>The following example uses a dataset kindly provided by Wolfram Tempel, which
was collected at beamline 19-ID at the APS. This dataset is available for
download from <a class="reference external" href="http://dx.doi.org/10.5281/zenodo.45756"><img alt="DPF3" src="https://zenodo.org/badge/doi/10.5281/zenodo.45756.svg" /></a>.</p>
<p>This dataset consists of a tar archive of bz2-compressed images. Very recent
versions of DIALS can read these directly, however here we shall be using
DIALS 1.1, as included in CCP4 7.0. In that case, we need to uncompress the
image files first. To do that, we first extract the archive:</p>
<div class="highlight-python"><div class="highlight"><pre>tar xvf DPF3_247398.tar
</pre></div>
</div>
<p>then uncompress each of the 200 images. This will probably take a couple of
minutes if the files are on a local hard drive:</p>
<div class="highlight-python"><div class="highlight"><pre>bunzip2 *.bz2
</pre></div>
</div>
<div class="section" id="import">
<h3>Import<a class="headerlink" href="#import" title="Permalink to this headline">¶</a></h3>
<p>At this point we have no reason not to trust the image headers. We shall just
go ahead and import the whole sweep as normal:</p>
<div class="highlight-python"><div class="highlight"><pre>dials.import x247398/t1.0*.img
</pre></div>
</div>
<p>From the output we can see that beamline 19-ID at the APS is one that is
specifically recognised by DIALS. As expected we found a single sweep of
data. So all looks good so far.:</p>
<div class="highlight-python"><div class="highlight"><pre>--------------------------------------------------------------------------------
DataBlock 0
  format: &lt;class &#39;dxtbx.format.FormatSMVADSCSNAPSID19.FormatSMVADSCSNAPSID19&#39;&gt;
  num images: 200
  num sweeps: 1
  num stills: 0
--------------------------------------------------------------------------------
</pre></div>
</div>
<p>We can get some more information about the expected experiment details using
<strong class="program">dials.show</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre>dials.show datablock.json
</pre></div>
</div>
<p>which produces output including the experimental geometry:</p>
<div class="highlight-python"><div class="highlight"><pre>Detector:
Panel:
  pixel_size:{0.1024,0.1024}
  image_size: {3072,3072}
  trusted_range: {1,65535}
  thickness: 0
  material:
  mu: 0
  fast_axis: {1,0,0}
  slow_axis: {0,-1,0}
  origin: {-159.98,154.501,-150}
Max resolution: 1.355231

Beam:
    wavelength: 1.28215
    sample to source direction : {0,0,1}
    divergence: 0
    sigma divergence: 0
    polarization normal: {0,1,0}
    polarization fraction: 0.999
Beam centre: (159.98,154.50)

Scan:
    image range:   {1,200}
    oscillation:   {-100,1}

Goniometer:
    Rotation axis:   {-1,0,0}
    Fixed rotation:  {1,0,0,0,1,0,0,0,1}
    Setting rotation:{1,0,0,0,1,0,0,0,1}
</pre></div>
</div>
<p>At the moment we don&#8217;t know that any of this is wrong. Happily, the 19-ID-specific
format has recognised the &#8216;inverse phi&#8217; rotation of the goniometer at this
beamline, and thus produced a rotation axis of <tt class="docutils literal"><span class="pre">{-1,0,0}</span></tt> rather than
<tt class="docutils literal"><span class="pre">{1,0,0}</span></tt>. These inverse phi settings can the cause of problems with
processing data from currently unrecognised beamlines. As an aside, in such
a case we could force the rotation axis to be whatever we want like this:</p>
<div class="highlight-python"><div class="highlight"><pre>dials.import t1.0*.img geometry.goniometer.rotation_axis=-1,0,0
</pre></div>
</div>
<p>We can fix any aspect of the experimental geometry in this way, as long as we
know in advance what it should be. This information could all be included in
a file, say <tt class="file docutils literal"><span class="pre">site.phil</span></tt> and passed to <strong class="program">dials.import</strong> thus
combining the freedom of a site file with the ability to read image headers.
However, in general we would prefer to produce a new format in such cases.
More information about this is available in the <strong class="program">dxtbx</strong>
<a class="reference external" href="http://dx.doi.org/10.1107/S1600576714011996">paper</a></p>
</div>
<div class="section" id="find-spots">
<h3>Find Spots<a class="headerlink" href="#find-spots" title="Permalink to this headline">¶</a></h3>
<p>Spot-finding in DIALS usually works well for Pilatus detectors, where default
assumptions about Poisson statistics of pixel counts, unity gain and no point
spread are accurate. These assumptions are not correct for CCD detectors and
this can be another source of problems with data processing. This may be the
subject of a future tutorial! In this case though, the defaults do a
reasonable, though possibly non-optimal job. We continue on regardless,
requesting only a larger number of processes to speed the job up:</p>
<div class="highlight-python"><div class="highlight"><pre>dials.find_spots datablock.json nproc=4
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><!--<h3>Navigation</h3>-->
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../links.html">Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer container">
  <a href="http://www.diamond.ac.uk/"><img class="logofooter" alt="Diamond" src="../../_static/diamond_logo.png" /></a>
  <a href="http://www.ccp4.ac.uk/"><img class="logofooter" alt="CCP4" src="../../_static/CCP4-logo-plain.png" /></a>
  <a href="http://www.lbl.gov/"><img class="logofooter" alt="LBL" src="../../_static/LBL-logo-wide.jpeg" /></a>
  <a href="https://www.stfc.ac.uk/"><img class="logofooter" alt="STFC" src="../../_static/STFC_logo.png" /></a>
  </div>

  <script type="text/javascript">
     $(document).ready(function() {
         $(".toggle > *").hide();
         $(".toggle .header").show();
         $(".toggle .header").click(function() {
             $(this).parent().children().not(".header").toggle(400);
             $(this).parent().children(".header").toggleClass("open");
         })
     });
  </script>
  
    <div class="footer">
      &copy;2015, Diamond Light Source, Lawrence Berkeley National Laboratory and STFC.
      
    </div>

    

    

  </body>
</html>